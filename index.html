<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pengurusan Jualan</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --accent-color: #fd79a8;
            --text-color: #2d3436;
            --light-text: #dfe6e9;
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.18);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%);
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            box-shadow: 0 8px 42px 0 rgba(31, 38, 135, 0.3);
            transform: translateY(-5px);
        }
        
        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 10px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            z-index: 1000;
            overflow-y: auto;
            width: 180px; /* Reduced width */
        }
        
        .sidebar .nav-link {
            color: var(--text-color);
            border-radius: 10px;
            margin: 3px 8px; /* Reduced margin */
            transition: all 0.3s;
            padding: 8px 10px; /* Reduced padding */
            font-size: 0.9rem; /* Smaller font */
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: var(--primary-color);
            transform: translateX(3px);
        }
        
        .sidebar .nav-link i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            font-size: 0.9rem; /* Smaller icons */
        }
        
        .content {
            margin-left: 180px; /* Match sidebar width */
            padding: 20px;
            transition: all 0.3s;
        }
        
        .page-title {
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        .btn-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            transition: all 0.3s;
        }
        
        .btn-glass:hover {
            background: rgba(255, 255, 255, 0.25);
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: var(--text-color);
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.3);
            border-color: var(--primary-color);
        }
        
        table {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead {
            background: rgba(108, 92, 231, 0.2);
        }
        
        .table-hover tbody tr:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .badge-glass {
            background: var(--glass-bg);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        
        .stats-card {
            text-align: center;
            padding: 12px; /* Reduced padding */
        }
        
        .stats-card i {
            font-size: 2rem; /* Smaller icon */
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .stats-card .stats-value {
            font-size: 1.5rem; /* Smaller text */
            font-weight: 600;
            color: var(--text-color);
        }
        
        .stats-card .stats-label {
            font-size: 0.8rem; /* Smaller text */
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .month-selector {
            margin-bottom: 20px;
        }
        
        .month-selector .btn {
            margin: 0 3px 5px 0;
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .nav-tabs {
            border-bottom: 1px solid var(--glass-border);
        }
        
        .nav-tabs .nav-link {
            color: var(--text-color);
            border: none;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            padding: 8px 15px;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: var(--secondary-color);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background: transparent;
            border-bottom: 2px solid var(--primary-color);
        }

        #export-pdf-btn:hover {
    background: rgba(108, 92, 231, 0.2); /* lebih menonjol dengan warna utama */
    color: white;
}
        
        .logo {
            text-align: center;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .logo h4 {
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
            font-size: 1.2rem; /* Smaller logo text */
        }
        
        .logo span {
            font-size: 0.7rem; /* Smaller subtitle */
            color: var(--text-color);
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .content {
                margin-left: 0;
            }
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
            color: white;
        }
        
        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .pending { color: #ffd700; }
        .processing { color: #00d4ff; }
        .completed { color: #00ff88; }
        .total { color: #ff6b9d; }
        
        .order-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        
        
        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: black;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        
        
        .btn-action {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 2px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-action:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .modal-header {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            border-radius: 20px 20px 0 0;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.85rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-pending {
            background: rgba(255, 193, 7, 0.2);
            color: #ffd700;
        }
        
        .status-processing {
            background: rgba(23, 162, 184, 0.2);
            color: #00d4ff;
        }
        
        .status-completed {
            background: rgba(40, 167, 69, 0.2);
            color: #00ff88;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid rgba(255, 255, 255, 0.4);
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .receipt-preview {
            max-width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .google-form-notice {
            background: rgba(66, 133, 244, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: black;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .form-control:focus {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            color: black;
        }
        
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .btn-success {
            background: rgba(40, 167, 69, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-success:hover {
            background: rgba(40, 167, 69, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        #order {
    padding-left: 200px; /* beri ruang bawah navbar */
}

#order .dashboard-card {
    transform: scale(0.9);
    transform-origin: top left;
    margin-left: 20px;
}

    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-auto sidebar">
                <div class="logo">
                    <img src="img/uitm-logo.png" alt="Logo UiTM Press" style="max-height: 40px;">
                    <span>Sistem Jualan Penerbit UiTM</span>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#shopee" data-bs-toggle="tab">
                            <i class="fas fa-shopping-bag"></i> Shopee
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#jualan-fizikal" data-bs-toggle="tab">
                            <i class="fas fa-store"></i> Jualan Fizikal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#ebook" data-bs-toggle="tab">
                            <i class="fas fa-book-reader"></i> eBook
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#jualan-luar" data-bs-toggle="tab">
                            <i class="fas fa-shopping-cart"></i> Jualan Luar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#book-capital" data-bs-toggle="tab">
                            <i class="fas fa-book"></i> Book Capital
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#siswa" data-bs-toggle="tab">
                            <i class="fas fa-user-graduate"></i> Siswa
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#bayaran-invois" data-bs-toggle="tab">
                            <i class="fas fa-file-invoice"></i> Bayaran Invois
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#kad-petak" data-bs-toggle="tab">
                            <i class="fas fa-warehouse"></i> Kad Petak Digital
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#senarai-stok-kurang" data-bs-toggle="tab">
                            <i class="fas fa-exclamation-triangle"></i> Senarai Stok Kurang
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#kad-petak-history" data-bs-toggle="tab">
                            <i class="fas fa-history"></i> Kad Petak
                        </a>
                    </li>
                    <a class="nav-link" href="#order" data-bs-toggle="tab">
                        <i class="fas fa-shopping-cart"></i> Order
                    </a>
                </li>
                </ul>
            </div>
            

            <!-- Main Content -->
            <div class="col content">
                <div class="tab-content fade-in">
                    <!-- Dashboard -->
                    <div class="tab-pane fade show active" id="dashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="page-title mb-0"><i class="fas fa-chart-line me-2"></i>Dashboard Utama</h2>
                            <div>
                                <button class="btn btn-glass btn-lg" id="export-pdf-btn" style="color: var(--primary-color); border: 1px solid var(--primary-color);">
                                    <i class="fas fa-file-pdf me-2"></i>Export PDF Report
                                </button>
                            </div>
                        </div>
                        
                        <!-- Google Sheets Setup Modal -->
                        <div class="modal fade" id="setupModal" tabindex="-1" aria-labelledby="setupModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content" style="background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border);">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="setupModalLabel">
                                            <i class="fas fa-cog me-2"></i>Setup Google Sheets Integration
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>Langkah Setup:</strong><br>
                                            1. Buat Google Sheet baru<br>
                                            2. Copy URL Google Sheet dan masukkan di bawah<br>
                                            3. Pastikan Google Sheet boleh diakses oleh sesiapa yang ada link<br>
                                            4. Klik "Simpan & Sync" untuk mula menggunakan
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="sheets-url" class="form-label">Google Sheets URL:</label>
                                            <input type="url" class="form-control" id="sheets-url" placeholder="https://docs.google.com/spreadsheets/d/...">
                                            <div class="form-text">Masukkan URL lengkap Google Sheet anda</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="api-key" class="form-label">Google API Key (Optional):</label>
                                            <input type="text" class="form-control" id="api-key" placeholder="Masukkan API Key jika ada">
                                            <div class="form-text">Untuk akses yang lebih stabil, dapatkan API Key dari Google Cloud Console</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="auto-sync">
                                                <label class="form-check-label" for="auto-sync">
                                                    Auto sync setiap kali ada perubahan data
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div id="connection-status" class="alert" style="display: none;">
                                            <span id="status-text"></span>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="fas fa-times me-2"></i>Tutup
                                        </button>
                                        <button type="button" class="btn btn-primary" id="test-connection-btn">
                                            <i class="fas fa-wifi me-2"></i>Test Connection
                                        </button>
                                        <button type="button" class="btn btn-success" id="save-setup-btn">
                                            <i class="fas fa-save me-2"></i>Simpan & Sync
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sync Status -->
                        <div class="glass-card mb-4" id="sync-status-card" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1"><i class="fas fa-cloud me-2"></i>Google Apps Script Status</h5>
                                    <small id="sync-status-text" class="text-muted">Tidak disambung</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" id="manual-sync-btn">
                                        <i class="fas fa-sync me-1"></i>Sync Manual
                                    </button>
                                    <button class="btn btn-sm btn-outline-info me-2" id="load-data-btn">
                                        <i class="fas fa-download me-1"></i>Load Data
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="disconnect-btn">
                                        <i class="fas fa-unlink me-1"></i>Disconnect
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small>Terakhir sync: <span id="last-sync-time">-</span></small>
                            </div>
                            <div class="mt-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Data akan auto-sync setiap kali anda tambah/ubah maklumat
                                </small>
                            </div>
                        </div>
                        
                        <!-- First Row - Main Categories -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-shopping-bag"></i>
                                    <div class="stats-value" id="total-shopee">RM 0</div>
                                    <div class="stats-label">Jumlah Shopee</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-store"></i>
                                    <div class="stats-value" id="total-fizikal">RM 0</div>
                                    <div class="stats-label">Jumlah Jualan Fizikal</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-book-reader"></i>
                                    <div class="stats-value" id="total-ebook">RM 0</div>
                                    <div class="stats-label">Jumlah eBook</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-shopping-cart"></i>
                                    <div class="stats-value" id="total-jualan-luar">RM 0</div>
                                    <div class="stats-label">Jumlah Jualan Luar</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Second Row - Additional Categories -->
                        <div class="row">
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-book"></i>
                                    <div class="stats-value" id="total-book-capital">RM 0</div>
                                    <div class="stats-label">Jumlah Book Capital</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-user-graduate"></i>
                                    <div class="stats-value" id="total-siswa">RM 0</div>
                                    <div class="stats-label">Jumlah Siswa</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-file-invoice"></i>
                                    <div class="stats-value" id="total-invois">RM 0</div>
                                    <div class="stats-label">Jumlah Bayaran Invois</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3">
                                <div class="glass-card stats-card">
                                    <i class="fas fa-coins"></i>
                                    <div class="stats-value" id="total-pendapatan">RM 0</div>
                                    <div class="stats-label">JUMLAH KESELURUHAN</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="glass-card">
                                    <h4 class="mb-3">Jualan Bulanan (Januari - Disember)</h4>
                                    <div style="height: 300px;">
                                        <canvas id="monthlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shopee -->
                    <div class="tab-pane fade" id="shopee">
                        <h2 class="page-title"><i class="fas fa-shopping-bag me-2"></i>Shopee</h2>
                        
                        <div class="glass-card">
                            <div class="month-selector mb-4">
                                <h5 class="mb-3">Pilih Bulan:</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-glass month-btn" data-month="1">Jan</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="2">Feb</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="3">Mac</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="4">Apr</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="5">Mei</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="6">Jun</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="7">Jul</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="8">Ogos</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="9">Sept</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="10">Okt</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="11">Nov</button>
                                    <button type="button" class="btn btn-glass month-btn" data-month="12">Dis</button>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="shopee-date">Tarikh:</label>
                                        <input type="date" class="form-control" id="shopee-date">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="shopee-amount">Jumlah (RM):</label>
                                        <input type="number" class="form-control" id="shopee-amount" step="0.01">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="shopee-save">
                                <i class="fas fa-save me-2"></i>Simpan
                            </button>
                            
                            <div class="mt-4">
                                <h5>Jumlah Bulanan: <span id="shopee-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                            </div>
                            
                            <div class="table-responsive mt-4">
                                <table class="table table-hover" id="shopee-table">
                                    <thead>
                                        <tr>
                                            <th>Tarikh</th>
                                            <th>Jumlah (RM)</th>
                                            <th>Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Jualan Fizikal -->
                    <div class="tab-pane fade" id="jualan-fizikal">
                        <h2 class="page-title"><i class="fas fa-store me-2"></i>Jualan Fizikal</h2>
                        
                        <ul class="nav nav-tabs" id="fizikalTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="bookstore-tab" data-bs-toggle="tab" data-bs-target="#bookstore" type="button" role="tab">Bookstore</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="purchase-order-tab" data-bs-toggle="tab" data-bs-target="#purchase-order" type="button" role="tab">Purchase Order</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="fizikalTabContent">
                            <!-- Bookstore Tab -->
                            <div class="tab-pane fade show active" id="bookstore" role="tabpanel">
                                <div class="glass-card">
                                    <div class="month-selector mb-4">
                                        <h5 class="mb-3">Pilih Bulan:</h5>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="1">Jan</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="2">Feb</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="3">Mac</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="4">Apr</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="5">Mei</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="6">Jun</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="7">Jul</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="8">Ogos</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="9">Sept</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="10">Okt</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="11">Nov</button>
                                            <button type="button" class="btn btn-glass bookstore-month-btn" data-month="12">Dis</button>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="bookstore-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="bookstore-date">
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="bookstore-qr">QR (RM):</label>
                                                        <input type="number" class="form-control" id="bookstore-qr" step="0.01">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="bookstore-debit">Debit (RM):</label>
                                                        <input type="number" class="form-control" id="bookstore-debit" step="0.01">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="bookstore-kredit">Kredit (RM):</label>
                                                        <input type="number" class="form-control" id="bookstore-kredit" step="0.01">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="bookstore-save">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                    
                                    <div class="mt-4">
                                        <h5>Jumlah Bulanan: <span id="bookstore-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="bookstore-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>QR (RM)</th>
                                                    <th>Debit (RM)</th>
                                                    <th>Kredit (RM)</th>
                                                    <th>Jumlah (RM)</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Purchase Order Tab -->
                            <div class="tab-pane fade" id="purchase-order" role="tabpanel">
                                <div class="glass-card">
                                    <div class="month-selector mb-4">
                                        <h5 class="mb-3">Pilih Bulan:</h5>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="1">Jan</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="2">Feb</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="3">Mac</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="4">Apr</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="5">Mei</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="6">Jun</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="7">Jul</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="8">Ogos</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="9">Sept</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="10">Okt</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="11">Nov</button>
                                            <button type="button" class="btn btn-glass po-month-btn" data-month="12">Dis</button>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="po-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="po-date">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="po-amount">Jumlah (RM):</label>
                                                <input type="number" class="form-control" id="po-amount" step="0.01">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="po-nota">Nota:</label>
                                                <input type="text" class="form-control" id="po-nota">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="po-save">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                    
                                    <div class="mt-4">
                                        <h5>Jumlah Bulanan: <span id="po-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="po-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>Jumlah (RM)</th>
                                                    <th>Nota</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-4">
                            <h4>Jumlah Keseluruhan Jualan Fizikal</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Jumlah Bookstore: <span id="total-bookstore" class="badge bg-info">RM 0.00</span></h5>
                                </div>
                                <div class="col-md-6">
                                    <h5>Jumlah Purchase Order: <span id="total-po" class="badge bg-info">RM 0.00</span></h5>
                                </div>
                            </div>
                            <h5 class="mt-3">Jumlah Keseluruhan: <span id="total-fizikal-display" class="badge bg-success">RM 0.00</span></h5>
                        </div>
                    </div>

                    <!-- eBook -->
                    <div class="tab-pane fade" id="ebook">
                        <h2 class="page-title"><i class="fas fa-book-reader me-2"></i>eBook</h2>
                        
                        <ul class="nav nav-tabs" id="ebookTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="googleplay-tab" data-bs-toggle="tab" data-bs-target="#googleplay" type="button" role="tab">Google Play</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="mindappz-tab" data-bs-toggle="tab" data-bs-target="#mindappz" type="button" role="tab">Mindappz</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="esentral-tab" data-bs-toggle="tab" data-bs-target="#esentral" type="button" role="tab">e-Sentral</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="ebookTabContent">
                            <!-- Google Play Tab -->
                            <div class="tab-pane fade show active" id="googleplay" role="tabpanel">
                                <div class="glass-card">
                                    <div class="month-selector mb-4">
                                        <h5 class="mb-3">Pilih Bulan:</h5>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="1">Jan</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="2">Feb</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="3">Mac</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="4">Apr</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="5">Mei</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="6">Jun</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="7">Jul</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="8">Ogos</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="9">Sept</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="10">Okt</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="11">Nov</button>
                                            <button type="button" class="btn btn-glass gplay-month-btn" data-month="12">Dis</button>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="gplay-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="gplay-date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="gplay-amount">Jumlah (RM):</label>
                                                <input type="number" class="form-control" id="gplay-amount" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="gplay-save">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                    
                                    <div class="mt-4">
                                        <h5>Jumlah Bulanan: <span id="gplay-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="gplay-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>Jumlah (RM)</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mindappz Tab -->
                            <div class="tab-pane fade" id="mindappz" role="tabpanel">
                                <div class="glass-card">
                                    <div class="month-selector mb-4">
                                        <h5 class="mb-3">Pilih Bulan:</h5>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="1">Jan</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="2">Feb</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="3">Mac</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="4">Apr</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="5">Mei</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="6">Jun</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="7">Jul</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="8">Ogos</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="9">Sept</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="10">Okt</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="11">Nov</button>
                                            <button type="button" class="btn btn-glass mindappz-month-btn" data-month="12">Dis</button>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="mindappz-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="mindappz-date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="mindappz-amount">Jumlah (RM):</label>
                                                <input type="number" class="form-control" id="mindappz-amount" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="mindappz-save">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                    
                                    <div class="mt-4">
                                        <h5>Jumlah Bulanan: <span id="mindappz-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="mindappz-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>Jumlah (RM)</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- e-Sentral Tab -->
                            <div class="tab-pane fade" id="esentral" role="tabpanel">
                                <div class="glass-card">
                                    <div class="month-selector mb-4">
                                        <h5 class="mb-3">Pilih Bulan:</h5>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="1">Jan</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="2">Feb</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="3">Mac</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="4">Apr</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="5">Mei</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="6">Jun</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="7">Jul</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="8">Ogos</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="9">Sept</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="10">Okt</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="11">Nov</button>
                                            <button type="button" class="btn btn-glass esentral-month-btn" data-month="12">Dis</button>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="esentral-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="esentral-date">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="esentral-amount">Jumlah (RM):</label>
                                                <input type="number" class="form-control" id="esentral-amount" step="0.01">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary" id="esentral-save">
                                        <i class="fas fa-save me-2"></i>Simpan
                                    </button>
                                    
                                    <div class="mt-4">
                                        <h5>Jumlah Bulanan: <span id="esentral-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                                    </div>
                                    
                                    <div class="table-responsive mt-4">
                                        <table class="table table-hover" id="esentral-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>Jumlah (RM)</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-4">
                            <h4>Jumlah Keseluruhan eBook</h4>
                            <div class="row">
                                <div class="col-md-4">
                                    <h5>Google Play: <span id="total-gplay" class="badge bg-info">RM 0.00</span></h5>
                                </div>
                                <div class="col-md-4">
                                    <h5>Mindappz: <span id="total-mindappz" class="badge bg-info">RM 0.00</span></h5>
                                </div>
                                <div class="col-md-4">
                                    <h5>e-Sentral: <span id="total-esentral" class="badge bg-info">RM 0.00</span></h5>
                                </div>
                            </div>
                            <h5 class="mt-3">Jumlah Keseluruhan: <span id="total-ebook-display" class="badge bg-success">RM 0.00</span></h5>
                        </div>
                    </div>

                    <!-- Jualan Luar -->
                    <div class="tab-pane fade" id="jualan-luar">
                        <h2 class="page-title"><i class="fas fa-shopping-cart me-2"></i>Jualan Luar</h2>
                        
                        <div class="glass-card">
                            <div class="month-selector mb-4">
                                <h5 class="mb-3">Pilih Bulan:</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="1">Jan</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="2">Feb</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="3">Mac</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="4">Apr</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="5">Mei</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="6">Jun</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="7">Jul</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="8">Ogos</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="9">Sept</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="10">Okt</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="11">Nov</button>
                                    <button type="button" class="btn btn-glass jl-month-btn" data-month="12">Dis</button>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="jl-date">Tarikh:</label>
                                        <input type="date" class="form-control" id="jl-date">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="jl-amount">Jumlah (RM):</label>
                                        <input type="number" class="form-control" id="jl-amount" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="jl-lokasi">Lokasi:</label>
                                        <input type="text" class="form-control" id="jl-lokasi">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="jl-nota">Nota:</label>
                                        <input type="text" class="form-control" id="jl-nota" placeholder="Nota tambahan">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="jl-save">
                                <i class="fas fa-save me-2"></i>Simpan
                            </button>
                            
                            <div class="mt-4">
                                <h5>Jumlah Bulanan: <span id="jl-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                            </div>
                            
                            <div class="table-responsive mt-4">
                                <table class="table table-hover" id="jl-table">
                                    <thead>
                                        <tr>
                                            <th>Tarikh</th>
                                            <th>Jumlah (RM)</th>
                                            <th>Lokasi</th>
                                            <th>Nota</th>
                                            <th>Status</th>
                                            <th>Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Book Capital -->
                    <div class="tab-pane fade" id="book-capital">
                        <h2 class="page-title"><i class="fas fa-book me-2"></i>Book Capital</h2>
                        
                        <div class="glass-card">
                            <div class="month-selector mb-4">
                                <h5 class="mb-3">Pilih Bulan:</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="1">Jan</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="2">Feb</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="3">Mac</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="4">Apr</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="5">Mei</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="6">Jun</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="7">Jul</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="8">Ogos</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="9">Sept</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="10">Okt</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="11">Nov</button>
                                    <button type="button" class="btn btn-glass bc-month-btn" data-month="12">Dis</button>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="bc-date">Tarikh:</label>
                                        <input type="date" class="form-control" id="bc-date">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="bc-amount">Jumlah (RM):</label>
                                        <input type="number" class="form-control" id="bc-amount" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="bc-nota">Nota:</label>
                                        <input type="text" class="form-control" id="bc-nota" placeholder="Nota tambahan">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="bc-save">
                                <i class="fas fa-save me-2"></i>Simpan
                            </button>
                            
                            <div class="mt-4">
                                <h5>Jumlah Bulanan: <span id="bc-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                            </div>
                            
                            <div class="table-responsive mt-4">
                                <table class="table table-hover" id="bc-table">
                                    <thead>
                                        <tr>
                                            <th>Tarikh</th>
                                            <th>Jumlah (RM)</th>
                                            <th>Nota</th>
                                            <th>Status</th>
                                            <th>Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Siswa -->
                    <div class="tab-pane fade" id="siswa">
                        <h2 class="page-title"><i class="fas fa-user-graduate me-2"></i>Siswa</h2>
                        
                        <div class="glass-card">
                            <div class="month-selector mb-4">
                                <h5 class="mb-3">Pilih Bulan:</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="1">Jan</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="2">Feb</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="3">Mac</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="4">Apr</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="5">Mei</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="6">Jun</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="7">Jul</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="8">Ogos</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="9">Sept</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="10">Okt</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="11">Nov</button>
                                    <button type="button" class="btn btn-glass siswa-month-btn" data-month="12">Dis</button>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="siswa-date">Tarikh:</label>
                                        <input type="date" class="form-control" id="siswa-date">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="siswa-amount">Jumlah (RM):</label>
                                        <input type="number" class="form-control" id="siswa-amount" step="0.01">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="siswa-nota">Nota:</label>
                                        <input type="text" class="form-control" id="siswa-nota" placeholder="Nota tambahan">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="siswa-save">
                                <i class="fas fa-save me-2"></i>Simpan
                            </button>
                            
                            <div class="mt-4">
                                <h5>Jumlah Bulanan: <span id="siswa-monthly-total" class="badge bg-primary">RM 0.00</span></h5>
                            </div>
                            
                            <div class="table-responsive mt-4">
                                <table class="table table-hover" id="siswa-table">
                                    <thead>
                                        <tr>
                                            <th>Tarikh</th>
                                            <th>Jumlah (RM)</th>
                                            <th>Nota</th>
                                            <th>Status</th>
                                            <th>Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bayaran Invois -->
                    <div class="tab-pane fade" id="bayaran-invois">
                        <h2 class="page-title"><i class="fas fa-file-invoice me-2"></i>Bayaran Invois</h2>
                        
                        <div class="glass-card">
                            <h4 class="mb-4">Tambah Permohonan Baru</h4>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-bilangan">Bilangan:</label>
                                        <input type="text" class="form-control" id="inv-bilangan">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-pelanggan">Nama Pelanggan:</label>
                                        <input type="text" class="form-control" id="inv-pelanggan">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-pegawai">Pegawai Bertanggungjawab:</label>
                                        <input type="text" class="form-control" id="inv-pegawai">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-judul">Judul Buku:</label>
                                        <input type="text" class="form-control" id="inv-judul">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-kuantiti">Kuantiti:</label>
                                        <input type="number" class="form-control" id="inv-kuantiti">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-rujukan">No. Rujukan:</label>
                                        <input type="text" class="form-control" id="inv-rujukan">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-tarikh-mohon">Tarikh Permohonan:</label>
                                        <input type="date" class="form-control" id="inv-tarikh-mohon">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-jab">JAB/UKZ/CWG Pembayaran:</label>
                                        <input type="text" class="form-control" id="inv-jab">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-tarikh-serah">Tarikh Serahan:</label>
                                        <input type="date" class="form-control" id="inv-tarikh-serah">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-jumlah">Jumlah (RM):</label>
                                        <input type="number" class="form-control" id="inv-jumlah" step="0.01">
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" id="inv-add">
                                <i class="fas fa-plus me-2"></i>Tambah Permohonan
                            </button>
                        </div>
                        
                        <div class="glass-card mt-4">
                            <h4 class="mb-4">Senarai Permohonan</h4>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="inv-table">
                                    <thead>
                                        <tr>
                                            <th>Bilangan</th>
                                            <th>Pelanggan</th>
                                            <th>Judul Buku</th>
                                            <th>Kuantiti</th>
                                            <th>Jumlah (RM)</th>
                                            <th>Status</th>
                                            <th>Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Details Modal -->
                        <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content" style="background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border);">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="detailsModalLabel">
                                            <i class="fas fa-info-circle me-2"></i>Maklumat Lengkap Permohonan
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <strong>Bilangan:</strong>
                                                <div id="detail-bilangan" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <strong>Nama Pelanggan:</strong>
                                                <div id="detail-pelanggan" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <strong>Pegawai Bertanggungjawab:</strong>
                                                <div id="detail-pegawai" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <strong>Judul Buku:</strong>
                                                <div id="detail-judul" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <strong>Kuantiti:</strong>
                                                <div id="detail-kuantiti" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <strong>No. Rujukan:</strong>
                                                <div id="detail-rujukan" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <strong>Tarikh Permohonan:</strong>
                                                <div id="detail-tarikh-mohon" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <strong>JAB/UKZ/CWG Pembayaran:</strong>
                                                <div id="detail-jab" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <strong>Tarikh Serahan:</strong>
                                                <div id="detail-tarikh-serah" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <strong>Jumlah:</strong>
                                                <div id="detail-jumlah" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1); font-weight: bold; color: var(--primary-color);">-</div>
                                            </div>
                                        </div>
                                        
                                        <div id="payment-details" style="display: none;">
                                            <hr style="border-color: var(--glass-border);">
                                            <h6 class="mb-3"><i class="fas fa-money-bill me-2"></i>Maklumat Pembayaran</h6>
                                            
                                            <div class="row">
                                                <div class="col-md-4 mb-3">
                                                    <strong>No. Invois:</strong>
                                                    <div id="detail-inv-no" class="mt-1 p-2 rounded" style="background: rgba(108, 92, 231, 0.2);">-</div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <strong>Tarikh Invois:</strong>
                                                    <div id="detail-inv-tarikh" class="mt-1 p-2 rounded" style="background: rgba(108, 92, 231, 0.2);">-</div>
                                                </div>
                                                <div class="col-md-4 mb-3">
                                                    <strong>Bayaran Diterima:</strong>
                                                    <div id="detail-inv-bayaran" class="mt-1 p-2 rounded" style="background: rgba(40, 167, 69, 0.2); font-weight: bold;">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="fas fa-times me-2"></i>Tutup
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass-card mt-4" id="inv-payment-form" style="display: none;">
                            <h4 class="mb-4">Tambah Maklumat Pembayaran</h4>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-no">No. Invois:</label>
                                        <input type="text" class="form-control" id="inv-no">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-tarikh">Tarikh Invois:</label>
                                        <input type="date" class="form-control" id="inv-tarikh">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="inv-bayaran">Bayaran Diterima (RM):</label>
                                        <input type="number" class="form-control" id="inv-bayaran" step="0.01">
                                    </div>
                                </div>
                            </div>
                            
                            <input type="hidden" id="inv-payment-id">
                            
                            <button class="btn btn-success" id="inv-save-payment">
                                <i class="fas fa-save me-2"></i>Simpan Pembayaran
                            </button>
                            <button class="btn btn-secondary ms-2" id="inv-cancel-payment">
                                <i class="fas fa-times me-2"></i>Batal
                            </button>
                        </div>
                    </div>

                    <!-- Senarai Stok Kurang -->
                    <div class="tab-pane fade" id="senarai-stok-kurang">
                        <h2 class="page-title"><i class="fas fa-exclamation-triangle me-2"></i>Senarai Stok Kurang</h2>
                        
                        <div class="glass-card">
                            <h4 class="mb-4">Senarai Stok Kurang</h4>
                            
                            <!-- Alert Summary -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="alert alert-warning">
                                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Stok Terhad (Bawah 300)</h5>
                                        <span id="terhad-count" class="badge bg-warning">0</span> buku
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-danger">
                                        <h5><i class="fas fa-exclamation-circle me-2"></i>Stok Kritikal (Bawah 100)</h5>
                                        <span id="kritikal-count" class="badge bg-danger">0</span> buku
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Low Stock Table -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="low-stock-table">
                                    <thead>
                                        <tr>
                                            <th>Status</th>
                                            <th>Tajuk Buku</th>
                                            <th>ISBN</th>
                                            <th>Rak</th>
                                            <th>Baki Semasa</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Low stock books will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Kad Petak -->
                    <div class="tab-pane fade" id="kad-petak-history">
                        <h2 class="page-title"><i class="fas fa-history me-2"></i>Kad Petak</h2>
                        
                        <div class="glass-card">
                            <h4 class="mb-4">Kad Petak - Sejarah Buku</h4>
                            
                            <!-- Search Section -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="search-book-history-main">Cari Tajuk Buku:</label>
                                        <input type="text" class="form-control" id="search-book-history-main" placeholder="Taip untuk cari sejarah buku...">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>&nbsp;</label>
                                        <button class="btn btn-primary form-control" id="view-book-history-main">
                                            <i class="fas fa-search me-2"></i>Lihat Sejarah
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Book Details Card -->
                            <div class="glass-card mb-4" id="book-details-card-main" style="display: none;">
                                <h5>Maklumat Buku</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Tajuk:</strong>
                                        <div id="book-title-main" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ISBN:</strong>
                                        <div id="book-isbn-main" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Rak:</strong>
                                        <div id="book-rak-main" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Baki Buku:</strong>
                                        <div id="book-balance-main" class="mt-1 p-2 rounded" style="background: rgba(40, 167, 69, 0.2); font-weight: bold;">-</div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <strong>Owner:</strong>
                                        <div id="book-owner-main" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">Ajim</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- History Table -->
                            <div class="table-responsive">
                                <table class="table table-hover" id="book-history-table-main">
                                    <thead>
                                        <tr>
                                            <th>Tarikh</th>
                                            <th>No. GRN</th>
                                            <th>Jenis</th>
                                            <th>Kuantiti</th>
                                            <th>Baki Selepas</th>
                                            <th>Nota</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Book history will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Kad Petak Digital -->
                    <div class="tab-pane fade" id="kad-petak">
                        <h2 class="page-title"><i class="fas fa-warehouse me-2"></i>Kad Petak Digital</h2>
                        
                        <!-- Single Login Form for Kad Petak Digital -->
                        <div class="glass-card" id="kad-petak-login">
                            <div class="text-center mb-4">
                                <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                                <h4>Akses Terhad</h4>
                                <p class="text-muted">Sila log masuk untuk mengakses Kad Petak Digital</p>
                            </div>
                            
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="kad-petak-employee" class="form-label">No. Pekerja:</label>
                                        <input type="text" class="form-control" id="kad-petak-employee" placeholder="Masukkan No. Pekerja">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="kad-petak-password" class="form-label">Kata Laluan:</label>
                                        <input type="password" class="form-control" id="kad-petak-password" placeholder="Masukkan Kata Laluan">
                                    </div>
                                    
                                    <div class="alert alert-danger" id="kad-petak-error" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        No. Pekerja atau Kata Laluan tidak sah!
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button class="btn btn-primary btn-lg" id="kad-petak-login-btn">
                                            <i class="fas fa-sign-in-alt me-2"></i>Log Masuk
                                        </button>
                                    </div>
                                    
                                    <div class="mt-3 text-center">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Sesi login akan kekal selama 8 jam
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Content (Hidden until login) -->
                        <div id="kad-petak-content" style="display: none;">
                            <!-- Logout Button -->
                            <div class="glass-card mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Sistem Kad Petak Digital</h5>
                                        <small class="text-muted">Selamat datang ke sistem pengurusan stok</small>
                                    </div>
                                    <button class="btn btn-outline-danger" id="kad-petak-logout-btn">
                                        <i class="fas fa-sign-out-alt me-2"></i>Log Keluar
                                    </button>
                                </div>
                            </div>
                            
                            <ul class="nav nav-tabs" id="kadPetakTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="pengeluaran-tab" data-bs-toggle="tab" data-bs-target="#pengeluaran" type="button" role="tab">Pengeluaran & Penambahan</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sejarah-tab" data-bs-toggle="tab" data-bs-target="#sejarah" type="button" role="tab">Kad Petak</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tambah-buku-tab" data-bs-toggle="tab" data-bs-target="#tambah-buku" type="button" role="tab">Tambah Buku</button>
                                </li>
                            </ul>
                        
                        <div class="tab-content" id="kadPetakTabContent">
                            <!-- Pengeluaran & Penambahan Tab -->
                            <div class="tab-pane fade show active" id="pengeluaran" role="tabpanel">
                                <div class="glass-card">
                                    <h4 class="mb-4">Pengeluaran & Penambahan Buku</h4>
                                    
                                    <!-- Search Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-12">
                                            <div class="form-group">
                                                <label for="search-book">Cari Tajuk Buku:</label>
                                                <input type="text" class="form-control" id="search-book" placeholder="Taip untuk cari buku...">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Search Results -->
                                    <div class="mb-4" id="search-results" style="display: none;">
                                        <h5>Hasil Carian:</h5>
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="search-results-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tajuk Buku</th>
                                                        <th>ISBN</th>
                                                        <th>Rak</th>
                                                        <th>Stok Semasa</th>
                                                        <th>Tindakan</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Search results will appear here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Selected Books List -->
                                    <div class="mb-4">
                                        <h5>Senarai Buku Dipilih:</h5>
                                        <div class="table-responsive">
                                            <table class="table table-hover" id="selected-books-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tajuk Buku</th>
                                                        <th>ISBN</th>
                                                        <th>Stok Semasa</th>
                                                        <th>Jenis</th>
                                                        <th>Kuantiti</th>
                                                        <th>Tindakan</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Selected books will appear here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Transaction Details -->
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="transaction-date">Tarikh:</label>
                                                <input type="date" class="form-control" id="transaction-date">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="grn-number">No. GRN:</label>
                                                <input type="text" class="form-control" id="grn-number" placeholder="Masukkan No. GRN">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="transaction-notes">Nota:</label>
                                                <input type="text" class="form-control" id="transaction-notes" placeholder="Nota tambahan">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-success btn-lg" id="process-transaction">
                                        <i class="fas fa-save me-2"></i>Proses Transaksi
                                    </button>
                                </div>
                                
                                <!-- Recent Transactions -->
                                <div class="glass-card mt-4">
                                    <h5>Transaksi Terkini</h5>
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="recent-transactions-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>No. GRN</th>
                                                    <th>Jumlah Item</th>
                                                    <th>Jenis</th>
                                                    <th>Nota</th>
                                                    <th>Tindakan</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Recent transactions will appear here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Kad Petak Tab -->
                            <div class="tab-pane fade" id="sejarah" role="tabpanel">
                                <div class="glass-card">
                                    <h4 class="mb-4">Kad Petak - Sejarah Buku</h4>
                                    
                                    <!-- Search Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-8">
                                            <div class="form-group">
                                                <label for="search-book-history">Cari Tajuk Buku:</label>
                                                <input type="text" class="form-control" id="search-book-history" placeholder="Taip untuk cari sejarah buku...">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label>&nbsp;</label>
                                                <button class="btn btn-primary form-control" id="view-book-history">
                                                    <i class="fas fa-search me-2"></i>Lihat Sejarah
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Book Details Card -->
                                    <div class="glass-card mb-4" id="book-details-card" style="display: none;">
                                        <h5>Maklumat Buku</h5>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>Tajuk:</strong>
                                                <div id="book-title" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>ISBN:</strong>
                                                <div id="book-isbn" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Rak:</strong>
                                                <div id="book-rak" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Baki Buku:</strong>
                                                <div id="book-balance" class="mt-1 p-2 rounded" style="background: rgba(40, 167, 69, 0.2); font-weight: bold;">-</div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <strong>Owner:</strong>
                                                <div id="book-owner" class="mt-1 p-2 rounded" style="background: rgba(255,255,255,0.1);">Ajim</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- History Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="book-history-table">
                                            <thead>
                                                <tr>
                                                    <th>Tarikh</th>
                                                    <th>No. GRN</th>
                                                    <th>Jenis</th>
                                                    <th>Kuantiti</th>
                                                    <th>Baki Selepas</th>
                                                    <th>Nota</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Book history will appear here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tambah Buku Tab -->
                            <div class="tab-pane fade" id="tambah-buku" role="tabpanel">
                                <div class="glass-card">
                                    <h4 class="mb-4">Tambah Buku Baru</h4>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="new-book-title">Tajuk Buku:</label>
                                                <input type="text" class="form-control" id="new-book-title" placeholder="Masukkan tajuk buku">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="new-book-isbn">ISBN:</label>
                                                <input type="text" class="form-control" id="new-book-isbn" placeholder="Masukkan ISBN">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="new-book-rak">Rak:</label>
                                                <input type="text" class="form-control" id="new-book-rak" placeholder="Masukkan lokasi rak">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label for="new-book-quantity">Kuantiti Awal:</label>
                                                <input type="number" class="form-control" id="new-book-quantity" placeholder="Masukkan kuantiti" min="0">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-success btn-lg" id="add-new-book">
                                        <i class="fas fa-plus me-2"></i>Tambah Buku
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Order -->
<div class="tab-pane fade" id="order" role="tabpanel">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-white text-center mb-0">
                    <i class="fas fa-clipboard-list me-3"></i>
                    Sistem Pengurusan Order
                </h1>
                <!-- Debug Panel -->
                <div class="text-center mt-3">
                    <div id="loadingStatus" class="text-warning mb-2" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading data from Google Sheets...
                    </div>
                    <div id="errorStatus" class="text-danger mb-2" style="display: none;"></div>
                    <button class="btn btn-outline-light btn-sm" onclick="testConnection()">
                        <i class="fas fa-plug me-1"></i>Test Connection
                    </button>
                    <span id="dataStatus" class="text-info ms-3"></span>
                </div>
            </div>
        </div>



        <!-- Dashboard Cards -->
        <div class="row mb-5">
            <div class="col-lg-4 col-md-6 col-12 mb-4">
                <div class="card dashboard-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-clock status-icon pending"></i>
                        <h3 class="card-title">Pending</h3>
                        <h2 class="text-warning" id="pendingCount">0</h2>
                        <p class="text-muted">Order Menunggu</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6 col-12 mb-4">
                <div class="card dashboard-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-check-circle status-icon completed"></i>
                        <h3 class="card-title">Selesai</h3>
                        <h2 class="text-success" id="completedCount">0</h2>
                        <p class="text-muted">Order Siap</p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 col-md-6 col-12 mb-4">
                <div class="card dashboard-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-chart-bar status-icon total"></i>
                        <h3 class="card-title">Jumlah Order</h3>
                        <h2 class="text-purple" id="totalCount">0</h2>
                        <p class="text-muted">Semua Order</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="row">
            <div class="col-12">
                <div class="order-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Bil.</th>
                                    <th>Nama Pengedar</th>
                                    <th>Tarikh</th>
                                    <th>Status</th>
                                    <th>Jenis</th>
                                    <th>No. DO</th>
                                    <th>Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
    <tr>
        <td colspan="7" class="text-center text-muted">
            Loading orders...
        </td>
    </tr>
</tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>
                        Detail Order <span id="modalOrderId"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-card">
                                <h6><i class="fas fa-user me-2"></i>Maklumat Pengedar</h6>
                                <p><strong>Nama:</strong> <span id="dealerName"></span></p>
                                <p><strong>Email:</strong> <span id="dealerEmail"></span></p>
                                <p><strong>No. Telefon:</strong> <span id="dealerPhone"></span></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <h6><i class="fas fa-map-marker-alt me-2"></i>Alamat & Penghantaran</h6>
                                <p><strong>Alamat:</strong> <span id="dealerAddress"></span></p>
                                <p><strong>Jenis:</strong> <span id="deliveryType"></span></p>
                                <p><strong>Status:</strong> <span id="orderStatus"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h6><i class="fas fa-book me-2"></i>Senarai Buku</h6>
                        <div id="booksList"></div>
                    </div>
                    
                    <div class="info-card" id="trackingSection" style="display: none;">
                        <h6><i class="fas fa-truck me-2"></i>Maklumat Penghantaran</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label"><strong>No. DO:</strong></label>
                                <input type="text" class="form-control" id="doNumber" placeholder="Masukkan No. DO">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>No. Tracking:</strong></label>
                                <input type="text" class="form-control" id="trackingNumber" placeholder="Masukkan No. Tracking">
                            </div>
                        </div>
                        <div class="text-center mb-3">
                            <button class="btn btn-success btn-lg" onclick="saveTracking()">
                                <i class="fas fa-save me-2"></i>Simpan & Selesaikan Order
                            </button>
                        </div>
                        <div id="currentTracking" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>No. DO:</strong> <span id="displayDO"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>No. Tracking:</strong> <span id="displayTracking"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3 text-end">
    <button class="btn btn-danger" onclick="exportOrdersPDF()">
        <i class="fas fa-file-pdf me-2"></i> Export PDF
    </button>
</div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize data storage
        const data = {
            shopee: Array(12).fill().map(() => []),
            bookstore: Array(12).fill().map(() => []),
            purchaseOrder: Array(12).fill().map(() => []),
            googlePlay: Array(12).fill().map(() => []),
            mindappz: Array(12).fill().map(() => []),
            esentral: Array(12).fill().map(() => []),
            jualanLuar: Array(12).fill().map(() => []),
            bookCapital: Array(12).fill().map(() => []),
            siswa: Array(12).fill().map(() => []),
            invois: [],
            // Kad Petak Digital data
            books: [], // Master book list
            transactions: [], // All stock transactions
            selectedBooks: [] // Temporary list for batch operations
        };
        
        // Google Sheets configuration
        let sheetsConfig = {
            spreadsheetId: null,
            apiKey: null,
            autoSync: false,
            isConnected: false,
            lastSync: null,
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycbzj_xtAQ43E1pC1_nhn05E8iiA8CS43OxY13q1D6tFaZeEUftA4tWmj5sgg0GJmp_pV/exec'
        };
        
        // Current selected month (0-indexed for arrays)
        let currentMonth = {
            shopee: 0,
            bookstore: 0,
            purchaseOrder: 0,
            googlePlay: 0,
            mindappz: 0,
            esentral: 0,
            jualanLuar: 0,
            bookCapital: 0,
            siswa: 0
        };

        // Chart instance
        let monthlyChart = null;
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ms-MY', { style: 'currency', currency: 'MYR' }).format(amount);
        }
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ms-MY');
        }
        
        // Calculate monthly totals
        function calculateMonthlyTotals() {
            // Shopee
            const shopeeTotals = data.shopee.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            
            // Bookstore
            const bookstoreTotals = data.bookstore.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.qr || 0) + parseFloat(item.debit || 0) + parseFloat(item.kredit || 0), 0)
            );
            
            // Purchase Order
            const poTotals = data.purchaseOrder.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            
            // Google Play
            const gplayTotals = data.googlePlay.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            
            // Mindappz
            const mindappzTotals = data.mindappz.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            
            // e-Sentral
            const esentralTotals = data.esentral.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            
            // Jualan Luar - only count paid amounts
            const jlTotals = data.jualanLuar.map(month => 
                month.reduce((sum, item) => sum + (item.paid ? parseFloat(item.amount || 0) : 0), 0)
            );
            
            // Book Capital - only count paid amounts
            const bcTotals = data.bookCapital.map(month => 
                month.reduce((sum, item) => sum + (item.paid ? parseFloat(item.amount || 0) : 0), 0)
            );
            
            // Siswa - only count paid amounts
            const siswaTotals = data.siswa.map(month => 
                month.reduce((sum, item) => sum + (item.paid ? parseFloat(item.amount || 0) : 0), 0)
            );
            
            // Calculate physical sales total
            const fizikalTotals = bookstoreTotals.map((val, idx) => val + poTotals[idx]);
            
            // Calculate eBook total
            const ebookTotals = gplayTotals.map((val, idx) => val + mindappzTotals[idx] + esentralTotals[idx]);
            
            // Calculate invoice payments
            const invoisTotal = data.invois
                .filter(item => item.paymentReceived)
                .reduce((sum, item) => sum + parseFloat(item.paymentReceived || 0), 0);
            
            // Calculate grand total
            const grandTotal = shopeeTotals.reduce((sum, val) => sum + val, 0) +
                              fizikalTotals.reduce((sum, val) => sum + val, 0) +
                              ebookTotals.reduce((sum, val) => sum + val, 0) +
                              jlTotals.reduce((sum, val) => sum + val, 0) +
                              bcTotals.reduce((sum, val) => sum + val, 0) +
                              siswaTotals.reduce((sum, val) => sum + val, 0) +
                              invoisTotal;
            
            // Update dashboard totals
            document.getElementById('total-pendapatan').textContent = formatCurrency(grandTotal);
            document.getElementById('total-shopee').textContent = formatCurrency(shopeeTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-fizikal').textContent = formatCurrency(fizikalTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-ebook').textContent = formatCurrency(ebookTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-jualan-luar').textContent = formatCurrency(jlTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-siswa').textContent = formatCurrency(siswaTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-book-capital').textContent = formatCurrency(bcTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-invois').textContent = formatCurrency(invoisTotal);
            
            // Update physical sales totals
            document.getElementById('total-bookstore').textContent = formatCurrency(bookstoreTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-po').textContent = formatCurrency(poTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-fizikal-display').textContent = formatCurrency(fizikalTotals.reduce((sum, val) => sum + val, 0));
            
            // Update eBook totals
            document.getElementById('total-gplay').textContent = formatCurrency(gplayTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-mindappz').textContent = formatCurrency(mindappzTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-esentral').textContent = formatCurrency(esentralTotals.reduce((sum, val) => sum + val, 0));
            document.getElementById('total-ebook-display').textContent = formatCurrency(ebookTotals.reduce((sum, val) => sum + val, 0));
            
            // Update monthly totals for each section
            document.getElementById('shopee-monthly-total').textContent = formatCurrency(shopeeTotals[currentMonth.shopee]);
            document.getElementById('bookstore-monthly-total').textContent = formatCurrency(bookstoreTotals[currentMonth.bookstore]);
            document.getElementById('po-monthly-total').textContent = formatCurrency(poTotals[currentMonth.purchaseOrder]);
            document.getElementById('gplay-monthly-total').textContent = formatCurrency(gplayTotals[currentMonth.googlePlay]);
            document.getElementById('mindappz-monthly-total').textContent = formatCurrency(mindappzTotals[currentMonth.mindappz]);
            document.getElementById('esentral-monthly-total').textContent = formatCurrency(esentralTotals[currentMonth.esentral]);
            document.getElementById('jl-monthly-total').textContent = formatCurrency(jlTotals[currentMonth.jualanLuar]);
            document.getElementById('bc-monthly-total').textContent = formatCurrency(bcTotals[currentMonth.bookCapital]);
            document.getElementById('siswa-monthly-total').textContent = formatCurrency(siswaTotals[currentMonth.siswa]);
            
            // Update monthly chart
            updateMonthlyChart(shopeeTotals, fizikalTotals, ebookTotals, jlTotals, bcTotals, siswaTotals);
        }
        
        // Update monthly chart
        function updateMonthlyChart(shopeeTotals, fizikalTotals, ebookTotals, jlTotals, bcTotals, siswaTotals) {
            const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogos', 'Sept', 'Okt', 'Nov', 'Dis'];
            
            // Check if any data exists
            const hasData = shopeeTotals.some(val => val > 0) || 
                           fizikalTotals.some(val => val > 0) || 
                           ebookTotals.some(val => val > 0) || 
                           jlTotals.some(val => val > 0) || 
                           bcTotals.some(val => val > 0) || 
                           siswaTotals.some(val => val > 0);
            
            // If no data, add sample data for demonstration
            if (!hasData) {
                shopeeTotals = [1000, 1200, 900, 1500, 1300, 1100, 1400, 1600, 1200, 1300, 1500, 1700];
                fizikalTotals = [800, 750, 900, 1000, 1100, 950, 1050, 1200, 1300, 1100, 1250, 1400];
                ebookTotals = [500, 600, 550, 700, 650, 600, 750, 800, 700, 750, 850, 900];
                jlTotals = [300, 350, 400, 450, 500, 400, 450, 550, 500, 600, 650, 700];
                bcTotals = [200, 250, 300, 350, 300, 250, 400, 450, 400, 500, 550, 600];
                siswaTotals = [150, 200, 250, 300, 250, 200, 350, 400, 350, 450, 500, 550];
            }
            
            // Destroy existing chart if it exists
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            
            // Get the canvas context
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Create new chart
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Shopee',
                            data: shopeeTotals,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 1
                        },
                        {
                            label: 'Jualan Fizikal',
                            data: fizikalTotals,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        },
                        {
                            label: 'eBook',
                            data: ebookTotals,
                            backgroundColor: 'rgba(255, 206, 86, 0.7)',
                            borderColor: 'rgb(255, 206, 86)',
                            borderWidth: 1
                        },
                        {
                            label: 'Jualan Luar',
                            data: jlTotals,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        },
                        {
                            label: 'Book Capital',
                            data: bcTotals,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgb(153, 102, 255)',
                            borderWidth: 1
                        },
                        {
                            label: 'Siswa',
                            data: siswaTotals,
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgb(255, 159, 64)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Jualan Bulanan Mengikut Kategori',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Bulan',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah (RM)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'RM ' + value;
                                },
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render tables
        function renderTables() {
            // Shopee table
            const shopeeTable = document.getElementById('shopee-table').getElementsByTagName('tbody')[0];
            shopeeTable.innerHTML = '';
            data.shopee[currentMonth.shopee].forEach((item, index) => {
                const row = shopeeTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="shopee" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Bookstore table
            const bookstoreTable = document.getElementById('bookstore-table').getElementsByTagName('tbody')[0];
            bookstoreTable.innerHTML = '';
            data.bookstore[currentMonth.bookstore].forEach((item, index) => {
                const total = parseFloat(item.qr || 0) + parseFloat(item.debit || 0) + parseFloat(item.kredit || 0);
                const row = bookstoreTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.qr)}</td>
                    <td>${formatCurrency(item.debit)}</td>
                    <td>${formatCurrency(item.kredit)}</td>
                    <td>${formatCurrency(total)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="bookstore" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Purchase Order table
            const poTable = document.getElementById('po-table').getElementsByTagName('tbody')[0];
            poTable.innerHTML = '';
            data.purchaseOrder[currentMonth.purchaseOrder].forEach((item, index) => {
                const row = poTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.nota}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="po" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Google Play table
            const gplayTable = document.getElementById('gplay-table').getElementsByTagName('tbody')[0];
            gplayTable.innerHTML = '';
            data.googlePlay[currentMonth.googlePlay].forEach((item, index) => {
                const row = gplayTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="gplay" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Mindappz table
            const mindappzTable = document.getElementById('mindappz-table').getElementsByTagName('tbody')[0];
            mindappzTable.innerHTML = '';
            data.mindappz[currentMonth.mindappz].forEach((item, index) => {
                const row = mindappzTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="mindappz" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // e-Sentral table
            const esentralTable = document.getElementById('esentral-table').getElementsByTagName('tbody')[0];
            esentralTable.innerHTML = '';
            data.esentral[currentMonth.esentral].forEach((item, index) => {
                const row = esentralTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="esentral" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Jualan Luar table
            const jlTable = document.getElementById('jl-table').getElementsByTagName('tbody')[0];
            jlTable.innerHTML = '';
            data.jualanLuar[currentMonth.jualanLuar].forEach((item, index) => {
                const status = item.paid ? 'Dibayar' : 'Belum Dibayar';
                const statusClass = item.paid ? 'bg-success' : 'bg-warning';
                const row = jlTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.lokasi}</td>
                    <td>${item.nota || '-'}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        ${!item.paid ? 
                            `<button class="btn btn-sm btn-success mark-paid-btn me-1" data-type="jl" data-index="${index}">
                                <i class="fas fa-check"></i> Dibayar
                            </button>` : 
                            `<button class="btn btn-sm btn-warning mark-unpaid-btn me-1" data-type="jl" data-index="${index}">
                                <i class="fas fa-undo"></i> Batal
                            </button>`
                        }
                        <button class="btn btn-sm btn-danger delete-btn" data-type="jl" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Book Capital table
            const bcTable = document.getElementById('bc-table').getElementsByTagName('tbody')[0];
            bcTable.innerHTML = '';
            data.bookCapital[currentMonth.bookCapital].forEach((item, index) => {
                const status = item.paid ? 'Dibayar' : 'Belum Dibayar';
                const statusClass = item.paid ? 'bg-success' : 'bg-warning';
                const row = bcTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.nota || '-'}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        ${!item.paid ? 
                            `<button class="btn btn-sm btn-success mark-paid-btn me-1" data-type="bc" data-index="${index}">
                                <i class="fas fa-check"></i> Dibayar
                            </button>` : 
                            `<button class="btn btn-sm btn-warning mark-unpaid-btn me-1" data-type="bc" data-index="${index}">
                                <i class="fas fa-undo"></i> Batal
                            </button>`
                        }
                        <button class="btn btn-sm btn-danger delete-btn" data-type="bc" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Siswa table
            const siswaTable = document.getElementById('siswa-table').getElementsByTagName('tbody')[0];
            siswaTable.innerHTML = '';
            data.siswa[currentMonth.siswa].forEach((item, index) => {
                const status = item.paid ? 'Dibayar' : 'Belum Dibayar';
                const statusClass = item.paid ? 'bg-success' : 'bg-warning';
                const row = siswaTable.insertRow();
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${formatCurrency(item.amount)}</td>
                    <td>${item.nota || '-'}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        ${!item.paid ? 
                            `<button class="btn btn-sm btn-success mark-paid-btn me-1" data-type="siswa" data-index="${index}">
                                <i class="fas fa-check"></i> Dibayar
                            </button>` : 
                            `<button class="btn btn-sm btn-warning mark-unpaid-btn me-1" data-type="siswa" data-index="${index}">
                                <i class="fas fa-undo"></i> Batal
                            </button>`
                        }
                        <button class="btn btn-sm btn-danger delete-btn" data-type="siswa" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Invois table
            const invTable = document.getElementById('inv-table').getElementsByTagName('tbody')[0];
            invTable.innerHTML = '';
            data.invois.forEach((item, index) => {
                const row = invTable.insertRow();
                const status = item.paymentReceived ? 'Dibayar' : 'Belum Dibayar';
                const statusClass = item.paymentReceived ? 'bg-success' : 'bg-warning';
                
                row.innerHTML = `
                    <td>${item.bilangan}</td>
                    <td>${item.pelanggan}</td>
                    <td>${item.judul}</td>
                    <td>${item.kuantiti}</td>
                    <td>${formatCurrency(item.jumlah)}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info view-details-btn me-1" data-index="${index}">
                            <i class="fas fa-eye"></i> Lihat
                        </button>
                        ${!item.paymentReceived ? 
                            `<button class="btn btn-sm btn-primary add-payment-btn me-1" data-index="${index}">
                                <i class="fas fa-money-bill"></i> Bayar
                            </button>` : 
                            `<span class="badge bg-success me-1">Selesai</span>`
                        }
                        <button class="btn btn-sm btn-danger delete-inv-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
            
            // Add event listeners for payment status buttons using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.mark-paid-btn')) {
                    const btn = e.target.closest('.mark-paid-btn');
                    const type = btn.getAttribute('data-type');
                    const index = parseInt(btn.getAttribute('data-index'));
                    
                    try {
                        if (type === 'bc') {
                            data.bookCapital[currentMonth.bookCapital][index].paid = true;
                        } else if (type === 'siswa') {
                            data.siswa[currentMonth.siswa][index].paid = true;
                        } else if (type === 'jl') {
                            data.jualanLuar[currentMonth.jualanLuar][index].paid = true;
                        }
                        
                        // Save data to localStorage
                        saveData();
                        
                        // Re-render tables and update totals
                        renderTables();
                        calculateMonthlyTotals();
                    } catch (error) {
                        console.error('Error marking as paid:', error);
                        alert('❌ Ralat semasa mengemaskini status pembayaran.');
                    }
                }
                
                if (e.target.closest('.mark-unpaid-btn')) {
                    const btn = e.target.closest('.mark-unpaid-btn');
                    const type = btn.getAttribute('data-type');
                    const index = parseInt(btn.getAttribute('data-index'));
                    
                    try {
                        if (type === 'bc') {
                            data.bookCapital[currentMonth.bookCapital][index].paid = false;
                        } else if (type === 'siswa') {
                            data.siswa[currentMonth.siswa][index].paid = false;
                        } else if (type === 'jl') {
                            data.jualanLuar[currentMonth.jualanLuar][index].paid = false;
                        }
                        
                        // Save data to localStorage
                        saveData();
                        
                        // Re-render tables and update totals
                        renderTables();
                        calculateMonthlyTotals();
                    } catch (error) {
                        console.error('Error marking as unpaid:', error);
                        alert('❌ Ralat semasa mengemaskini status pembayaran.');
                    }
                }
            });
            
            // Add event listeners for delete buttons using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.delete-btn')) {
                    const btn = e.target.closest('.delete-btn');
                    const type = btn.getAttribute('data-type');
                    const index = parseInt(btn.getAttribute('data-index'));
                    
                    // Get item details for confirmation message
                    let itemDetails = '';
                    let confirmMessage = '';
                    
                    try {
                        switch(type) {
                            case 'shopee':
                                const shopeeItem = data.shopee[currentMonth.shopee][index];
                                if (!shopeeItem) return;
                                itemDetails = `Tarikh: ${formatDate(shopeeItem.date)}\nJumlah: ${formatCurrency(shopeeItem.amount)}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Shopee ini?\n\n${itemDetails}`;
                                break;
                            case 'bookstore':
                                const bookstoreItem = data.bookstore[currentMonth.bookstore][index];
                                if (!bookstoreItem) return;
                                const total = parseFloat(bookstoreItem.qr || 0) + parseFloat(bookstoreItem.debit || 0) + parseFloat(bookstoreItem.kredit || 0);
                                itemDetails = `Tarikh: ${formatDate(bookstoreItem.date)}\nQR: ${formatCurrency(bookstoreItem.qr)}\nDebit: ${formatCurrency(bookstoreItem.debit)}\nKredit: ${formatCurrency(bookstoreItem.kredit)}\nJumlah: ${formatCurrency(total)}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Bookstore ini?\n\n${itemDetails}`;
                                break;
                            case 'po':
                                const poItem = data.purchaseOrder[currentMonth.purchaseOrder][index];
                                if (!poItem) return;
                                itemDetails = `Tarikh: ${formatDate(poItem.date)}\nJumlah: ${formatCurrency(poItem.amount)}\nNota: ${poItem.nota || '-'}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Purchase Order ini?\n\n${itemDetails}`;
                                break;
                            case 'gplay':
                                const gplayItem = data.googlePlay[currentMonth.googlePlay][index];
                                if (!gplayItem) return;
                                itemDetails = `Tarikh: ${formatDate(gplayItem.date)}\nJumlah: ${formatCurrency(gplayItem.amount)}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Google Play ini?\n\n${itemDetails}`;
                                break;
                            case 'mindappz':
                                const mindappzItem = data.mindappz[currentMonth.mindappz][index];
                                if (!mindappzItem) return;
                                itemDetails = `Tarikh: ${formatDate(mindappzItem.date)}\nJumlah: ${formatCurrency(mindappzItem.amount)}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Mindappz ini?\n\n${itemDetails}`;
                                break;
                            case 'esentral':
                                const esentralItem = data.esentral[currentMonth.esentral][index];
                                if (!esentralItem) return;
                                itemDetails = `Tarikh: ${formatDate(esentralItem.date)}\nJumlah: ${formatCurrency(esentralItem.amount)}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data e-Sentral ini?\n\n${itemDetails}`;
                                break;
                            case 'jl':
                                const jlItem = data.jualanLuar[currentMonth.jualanLuar][index];
                                if (!jlItem) return;
                                const jlStatus = jlItem.paid ? 'Dibayar' : 'Belum Dibayar';
                                itemDetails = `Tarikh: ${formatDate(jlItem.date)}\nJumlah: ${formatCurrency(jlItem.amount)}\nLokasi: ${jlItem.lokasi || '-'}\nNota: ${jlItem.nota || '-'}\nStatus: ${jlStatus}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Jualan Luar ini?\n\n${itemDetails}`;
                                break;
                            case 'bc':
                                const bcItem = data.bookCapital[currentMonth.bookCapital][index];
                                if (!bcItem) return;
                                const bcStatus = bcItem.paid ? 'Dibayar' : 'Belum Dibayar';
                                itemDetails = `Tarikh: ${formatDate(bcItem.date)}\nJumlah: ${formatCurrency(bcItem.amount)}\nNota: ${bcItem.nota || '-'}\nStatus: ${bcStatus}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Book Capital ini?\n\n${itemDetails}`;
                                break;
                            case 'siswa':
                                const siswaItem = data.siswa[currentMonth.siswa][index];
                                if (!siswaItem) return;
                                const siswaStatus = siswaItem.paid ? 'Dibayar' : 'Belum Dibayar';
                                itemDetails = `Tarikh: ${formatDate(siswaItem.date)}\nJumlah: ${formatCurrency(siswaItem.amount)}\nNota: ${siswaItem.nota || '-'}\nStatus: ${siswaStatus}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan data Siswa ini?\n\n${itemDetails}`;
                                break;
                            // Add Kad Petak delete functionality
                            case 'transaction':
                                const transactionId = btn.getAttribute('data-transaction-id');
                                const transaction = data.transactions.find(t => t.id === transactionId);
                                if (!transaction) return;
                                
                                let transactionDetails = `Tarikh: ${formatDate(transaction.date)}\n`;
                                transactionDetails += `No. GRN: ${transaction.grnNumber || '-'}\n`;
                                transactionDetails += `Nota: ${transaction.notes || '-'}\n`;
                                if (transaction.items && transaction.items.length > 0) {
                                    transactionDetails += `\nBuku yang terlibat (${transaction.items.length} item):\n`;
                                    transaction.items.forEach((item, idx) => {
                                        transactionDetails += `${idx + 1}. ${item.title} (${item.transactionType === 'masuk' ? '+' : '-'}${item.quantity})\n`;
                                    });
                                }
                                
                                confirmMessage = `Adakah anda pasti mahu memadamkan transaksi ini?\n\n${transactionDetails}\n⚠️ AMARAN: Tindakan ini akan membalikkan semua perubahan stok dalam transaksi ini!`;
                                
                                if (confirm(confirmMessage)) {
                                    // Reverse stock changes
                                    if (transaction.items && transaction.items.length > 0) {
                                        transaction.items.forEach(item => {
                                            const book = data.books.find(b => b.id === item.id);
                                            if (book) {
                                                if (item.transactionType === 'masuk') {
                                                    book.currentStock -= item.quantity;
                                                } else {
                                                    book.currentStock += item.quantity;
                                                }
                                                if (book.currentStock < 0) book.currentStock = 0;
                                            }
                                        });
                                    }
                                    
                                    // Remove all related transactions
                                    data.transactions = data.transactions.filter(t => t.transactionId !== transactionId);
                                    
                                    // Save data
                                    saveData();
                                    
                                    // Re-render tables
                                    renderRecentTransactionsTable();
                                    renderAllBooksTable();
                                    renderLowStockTable();
                                    
                                    alert('✅ Transaksi berjaya dipadamkan dan stok telah dikembalikan!');
                                }
                                return;
                            case 'book':
                                const bookId = btn.getAttribute('data-book-id');
                                const book = data.books.find(b => b.id === bookId);
                                if (!book) return;
                                
                                const bookDetails = `Tajuk: ${book.title}\nISBN: ${book.isbn}\nRak: ${book.rak}\nStok Semasa: ${book.currentStock}`;
                                confirmMessage = `Adakah anda pasti mahu memadamkan buku ini?\n\n${bookDetails}\n\n⚠️ AMARAN: Semua sejarah transaksi buku ini akan turut dipadamkan!`;
                                
                                if (confirm(confirmMessage)) {
                                    // Remove book
                                    data.books = data.books.filter(b => b.id !== bookId);
                                    
                                    // Remove related transactions
                                    data.transactions = data.transactions.filter(t => t.bookId !== bookId);
                                    
                                    // Remove from selected books if exists
                                    data.selectedBooks = data.selectedBooks.filter(b => b.id !== bookId);
                                    
                                    // Save data
                                    saveData();
                                    
                                    // Re-render tables
                                    renderAllBooksTable();
                                    renderLowStockTable();
                                    renderSelectedBooksTable();
                                    
                                    alert('✅ Buku berjaya dipadamkan!');
                                }
                                return;
                            case 'selected-book':
                                const selectedBookId = btn.getAttribute('data-book-id');
                                const selectedBook = data.selectedBooks.find(b => b.id === selectedBookId);
                                if (!selectedBook) return;
                                
                                const selectedBookDetails = `Tajuk: ${selectedBook.title}\nISBN: ${selectedBook.isbn}\nJenis: ${selectedBook.transactionType}\nKuantiti: ${selectedBook.quantity}`;
                                confirmMessage = `Adakah anda pasti mahu membuang buku ini dari senarai?\n\n${selectedBookDetails}`;
                                
                                if (confirm(confirmMessage)) {
                                    // Remove from selected books
                                    data.selectedBooks = data.selectedBooks.filter(b => b.id !== selectedBookId);
                                    
                                    // Re-render selected books table
                                    renderSelectedBooksTable();
                                    
                                    alert('✅ Buku berjaya dibuang dari senarai!');
                                }
                                return;
                            default:
                                console.error('Unknown delete type:', type);
                                return;
                        }
                        
                        // Show confirmation dialog
                        if (confirm(confirmMessage)) {
                            // User confirmed, proceed with deletion
                            switch(type) {
                                case 'shopee':
                                    data.shopee[currentMonth.shopee].splice(index, 1);
                                    break;
                                case 'bookstore':
                                    data.bookstore[currentMonth.bookstore].splice(index, 1);
                                    break;
                                case 'po':
                                    data.purchaseOrder[currentMonth.purchaseOrder].splice(index, 1);
                                    break;
                                case 'gplay':
                                    data.googlePlay[currentMonth.googlePlay].splice(index, 1);
                                    break;
                                case 'mindappz':
                                    data.mindappz[currentMonth.mindappz].splice(index, 1);
                                    break;
                                case 'esentral':
                                    data.esentral[currentMonth.esentral].splice(index, 1);
                                    break;
                                case 'jl':
                                    data.jualanLuar[currentMonth.jualanLuar].splice(index, 1);
                                    break;
                                case 'bc':
                                    data.bookCapital[currentMonth.bookCapital].splice(index, 1);
                                    break;
                                case 'siswa':
                                    data.siswa[currentMonth.siswa].splice(index, 1);
                                    break;
                            }
                            
                            // Save data to localStorage
                            saveData();
                            
                            // Re-render tables and update totals
                            renderTables();
                            calculateMonthlyTotals();
                            
                            // Show success message
                            alert('✅ Data berjaya dipadamkan!');
                        }
                        // If user cancels, do nothing
                    } catch (error) {
                        console.error('Error in delete operation:', error);
                        alert('❌ Ralat semasa memadamkan data. Sila cuba lagi.');
                    }
                }
            });
            
            // Add event listeners for invoice actions using event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.view-details-btn')) {
                    const btn = e.target.closest('.view-details-btn');
                    const index = parseInt(btn.getAttribute('data-index'));
                    const item = data.invois[index];
                    
                    if (!item) return;
                    
                    try {
                        // Populate modal with data
                        document.getElementById('detail-bilangan').textContent = item.bilangan || '-';
                        document.getElementById('detail-pelanggan').textContent = item.pelanggan || '-';
                        document.getElementById('detail-pegawai').textContent = item.pegawai || '-';
                        document.getElementById('detail-judul').textContent = item.judul || '-';
                        document.getElementById('detail-kuantiti').textContent = item.kuantiti || '-';
                        document.getElementById('detail-rujukan').textContent = item.rujukan || '-';
                        document.getElementById('detail-tarikh-mohon').textContent = formatDate(item.tarikhMohon);
                        document.getElementById('detail-jab').textContent = item.jab || '-';
                        document.getElementById('detail-tarikh-serah').textContent = formatDate(item.tarikhSerah);
                        document.getElementById('detail-jumlah').textContent = formatCurrency(item.jumlah);
                        
                        // Show payment details if payment has been made
                        const paymentDetails = document.getElementById('payment-details');
                        if (item.paymentReceived) {
                            document.getElementById('detail-inv-no').textContent = item.invoiceNo || '-';
                            document.getElementById('detail-inv-tarikh').textContent = formatDate(item.invoiceDate);
                            document.getElementById('detail-inv-bayaran').textContent = formatCurrency(item.paymentReceived);
                            paymentDetails.style.display = 'block';
                        } else {
                            paymentDetails.style.display = 'none';
                        }
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                        modal.show();
                    } catch (error) {
                        console.error('Error showing invoice details:', error);
                        alert('❌ Ralat semasa memaparkan maklumat invois.');
                    }
                }
                
                if (e.target.closest('.add-payment-btn')) {
                    const btn = e.target.closest('.add-payment-btn');
                    const index = parseInt(btn.getAttribute('data-index'));
                    
                    try {
                        document.getElementById('inv-payment-id').value = index;
                        document.getElementById('inv-payment-form').style.display = 'block';
                        
                        // Scroll to payment form
                        document.getElementById('inv-payment-form').scrollIntoView({ behavior: 'smooth' });
                    } catch (error) {
                        console.error('Error showing payment form:', error);
                        alert('❌ Ralat semasa membuka borang pembayaran.');
                    }
                }
                
                if (e.target.closest('.delete-inv-btn')) {
                    const btn = e.target.closest('.delete-inv-btn');
                    const index = parseInt(btn.getAttribute('data-index'));
                    const invoisItem = data.invois[index];
                    
                    if (!invoisItem) return;
                    
                    try {
                        // Get item details for confirmation message
                        const paymentStatus = invoisItem.paymentReceived ? 'Dibayar' : 'Belum Dibayar';
                        const itemDetails = `Bilangan: ${invoisItem.bilangan || '-'}\nPelanggan: ${invoisItem.pelanggan || '-'}\nJudul Buku: ${invoisItem.judul || '-'}\nKuantiti: ${invoisItem.kuantiti || '-'}\nJumlah: ${formatCurrency(invoisItem.jumlah || 0)}\nStatus: ${paymentStatus}`;
                        const confirmMessage = `Adakah anda pasti mahu memadamkan data Bayaran Invois ini?\n\n${itemDetails}\n\n⚠️ AMARAN: Tindakan ini tidak boleh dibatalkan!`;
                        
                        // Show confirmation dialog
                        if (confirm(confirmMessage)) {
                            // User confirmed, proceed with deletion
                            data.invois.splice(index, 1);
                            
                            // Save data to localStorage
                            saveData();
                            
                            // Re-render tables and update totals
                            renderTables();
                            calculateMonthlyTotals();
                            
                            // Show success message
                            alert('✅ Data Bayaran Invois berjaya dipadamkan!');
                        }
                        // If user cancels, do nothing
                    } catch (error) {
                        console.error('Error deleting invoice:', error);
                        alert('❌ Ralat semasa memadamkan data invois.');
                    }
                }
            });
        }
        
        // Google Sheets Integration Functions
        
        // Extract spreadsheet ID from URL
        function extractSpreadsheetId(url) {
            const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }
        
        // Initialize Google Sheets API
        function initGoogleSheetsAPI() {
            return new Promise((resolve, reject) => {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', () => {
                        gapi.client.init({
                            apiKey: sheetsConfig.apiKey,
                            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                        }).then(resolve).catch(reject);
                    });
                } else {
                    reject('Google API not loaded');
                }
            });
        }
        
        // Generate CSV data for manual import to Google Sheets
        function generateCSVData() {
            const csvData = [];
            
            // Add header
            csvData.push(['Timestamp', 'Category', 'Subcategory', 'Month', 'Date', 'Amount', 'QR', 'Debit', 'Kredit', 'Lokasi', 'Nota', 'Paid', 'Extra_Data']);
            
            // Add Shopee data
            data.shopee.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Shopee',
                        '',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', '', '', ''
                    ]);
                });
            });
            
            // Add Bookstore data
            data.bookstore.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Jualan Fizikal',
                        'Bookstore',
                        monthIndex + 1,
                        item.date,
                        '',
                        item.qr,
                        item.debit,
                        item.kredit,
                        '', '', '', ''
                    ]);
                });
            });
            
            // Add Purchase Order data
            data.purchaseOrder.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Jualan Fizikal',
                        'Purchase Order',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', item.nota, '', ''
                    ]);
                });
            });
            
            // Add Google Play data
            data.googlePlay.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'eBook',
                        'Google Play',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', '', '', ''
                    ]);
                });
            });
            
            // Add Mindappz data
            data.mindappz.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'eBook',
                        'Mindappz',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', '', '', ''
                    ]);
                });
            });
            
            // Add e-Sentral data
            data.esentral.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'eBook',
                        'e-Sentral',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', '', '', ''
                    ]);
                });
            });
            
            // Add Jualan Luar data
            data.jualanLuar.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Jualan Luar',
                        '',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', item.lokasi, item.nota, item.paid ? 'Yes' : 'No', ''
                    ]);
                });
            });
            
            // Add Book Capital data
            data.bookCapital.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Book Capital',
                        '',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', item.nota, item.paid ? 'Yes' : 'No', ''
                    ]);
                });
            });
            
            // Add Siswa data
            data.siswa.forEach((monthData, monthIndex) => {
                monthData.forEach(item => {
                    csvData.push([
                        new Date().toISOString(),
                        'Siswa',
                        '',
                        monthIndex + 1,
                        item.date,
                        item.amount,
                        '', '', '', '', item.nota, item.paid ? 'Yes' : 'No', ''
                    ]);
                });
            });
            
            // Add Invois data
            data.invois.forEach(item => {
                const extraData = JSON.stringify({
                    bilangan: item.bilangan,
                    pelanggan: item.pelanggan,
                    pegawai: item.pegawai,
                    judul: item.judul,
                    kuantiti: item.kuantiti,
                    rujukan: item.rujukan,
                    tarikhMohon: item.tarikhMohon,
                    jab: item.jab,
                    tarikhSerah: item.tarikhSerah,
                    invoiceNo: item.invoiceNo,
                    invoiceDate: item.invoiceDate,
                    paymentReceived: item.paymentReceived
                });
                
                csvData.push([
                    new Date().toISOString(),
                    'Bayaran Invois',
                    '',
                    '',
                    item.tarikhMohon,
                    item.jumlah,
                    '', '', '', '', '', item.paymentReceived ? 'Yes' : 'No', extraData
                ]);
            });
            
            return csvData;
        }
        
        // Download CSV file for manual import
        function downloadCSVFile() {
            const csvData = generateCSVData();
            
            // Convert to CSV string
            const csvString = csvData.map(row => 
                row.map(cell => {
                    // Escape quotes and wrap in quotes if contains comma or quote
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return '"' + cellStr.replace(/"/g, '""') + '"';
                    }
                    return cellStr;
                }).join(',')
            ).join('\n');
            
            // Create and download file
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `SalesPro_Data_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            return true;
        }
        
        // Save data to Google Sheets using Apps Script
        async function saveDataToSheets() {
            try {
                console.log('💾 Saving data to Google Apps Script...');
                
                // Use FormData to avoid CORS preflight requests
                const formData = new FormData();
                formData.append('action', 'saveData');
                formData.append('data', JSON.stringify(data));
                formData.append('timestamp', new Date().toISOString());
                
                // Send data to Apps Script using FormData
                const response = await fetch(sheetsConfig.appsScriptUrl, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if request was successful
                if (response.ok) {
                    try {
                        const result = await response.json();
                        if (result.success) {
                            sheetsConfig.lastSync = new Date().toISOString();
                            sheetsConfig.isConnected = true;
                            
                            // Also save to localStorage as backup
                            localStorage.setItem('salesData', JSON.stringify(data));
                            localStorage.setItem('lastSyncTime', sheetsConfig.lastSync);
                            
                            updateSyncStatus();
                            console.log('✅ Data berjaya disimpan ke Google Sheets!');
                            
                            return true;
                        } else {
                            throw new Error(result.error || 'Apps Script returned error');
                        }
                    } catch (jsonError) {
                        // If we can't parse JSON, assume success (some Apps Script responses are plain text)
                        sheetsConfig.lastSync = new Date().toISOString();
                        sheetsConfig.isConnected = true;
                        
                        localStorage.setItem('salesData', JSON.stringify(data));
                        localStorage.setItem('lastSyncTime', sheetsConfig.lastSync);
                        
                        updateSyncStatus();
                        console.log('✅ Data berjaya disimpan ke Google Sheets!');
                        
                        return true;
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                
                // Save to localStorage as fallback
                localStorage.setItem('salesData', JSON.stringify(data));
                localStorage.setItem('lastSyncTime', new Date().toISOString());
                
                // Show error but don't fail completely
                if (arguments[0] === 'manual') {
                    alert('⚠️ Gagal sync ke Google Sheets: ' + error.message + '\n\nData telah disimpan secara tempatan. Sila cuba lagi nanti.');
                }
                
                return false;
            }
        }
        
        // Load data from Google Sheets using Apps Script
        async function loadDataFromSheets() {
            try {
                console.log('🔄 Memuat data dari Google Apps Script...');
                
                // Use FormData to avoid CORS preflight requests
                const formData = new FormData();
                formData.append('action', 'loadData');
                formData.append('timestamp', new Date().toISOString());
                
                const response = await fetch(sheetsConfig.appsScriptUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Get response text first
                const responseText = await response.text();
                console.log('📥 Raw response dari Google Apps Script:', responseText.substring(0, 500));
                
                // Clean the response text - remove any HTML or non-JSON content
                let cleanedResponse = responseText.trim();
                
                // Check if response starts with HTML (common issue with Apps Script)
                if (cleanedResponse.startsWith('<!DOCTYPE') || cleanedResponse.startsWith('<html')) {
                    console.log('⚠️ Response mengandungi HTML. Mencari JSON dalam response...');
                    
                    // Try to extract JSON from HTML response
                    const jsonMatch = cleanedResponse.match(/\{.*\}/s);
                    if (jsonMatch) {
                        cleanedResponse = jsonMatch[0];
                        console.log('✅ JSON dijumpai dalam HTML response');
                    } else {
                        console.log('❌ Tiada JSON dijumpai dalam HTML response');
                        throw new Error('Response mengandungi HTML tanpa JSON data');
                    }
                }
                
                // Check if response is empty or just whitespace
                if (!cleanedResponse || cleanedResponse.length < 2) {
                    console.log('📝 Response kosong - mungkin tiada data dalam Google Sheets');
                    sheetsConfig.isConnected = true;
                    updateSyncStatus();
                    return true;
                }
                
                let result;
                try {
                    result = JSON.parse(cleanedResponse);
                    console.log('✅ JSON berjaya di-parse:', Object.keys(result));
                } catch (jsonError) {
                    console.log('⚠️ JSON parse gagal. Response:', cleanedResponse.substring(0, 200));
                    
                    // Check if response contains CSV-like data
                    if (cleanedResponse.includes('Timestamp,Category') || cleanedResponse.includes(',')) {
                        console.log('📊 Mengesan format CSV dalam response. Cuba parse sebagai CSV...');
                        
                        try {
                            const parsedData = parseCSVResponse(cleanedResponse);
                            if (parsedData && Object.keys(parsedData).length > 0) {
                                // Merge parsed data with existing data structure
                                Object.assign(data, parsedData);
                                
                                sheetsConfig.lastSync = new Date().toISOString();
                                sheetsConfig.isConnected = true;
                                
                                localStorage.setItem('salesData', JSON.stringify(data));
                                localStorage.setItem('lastSyncTime', sheetsConfig.lastSync);
                                
                                updateSyncStatus();
                                console.log('✅ Data CSV berjaya dimuat dari Google Sheets!');
                                
                                return true;
                            }
                        } catch (csvError) {
                            console.error('❌ Gagal parse CSV:', csvError);
                        }
                    }
                    
                    // If response looks like error message
                    if (cleanedResponse.toLowerCase().includes('error') || 
                        cleanedResponse.toLowerCase().includes('exception') ||
                        cleanedResponse.toLowerCase().includes('failed')) {
                        throw new Error('Google Apps Script error: ' + cleanedResponse.substring(0, 100));
                    }
                    
                    // If no data found, assume connection is working but no data exists
                    console.log('📝 Tiada data JSON dijumpai. Memulakan dengan data kosong.');
                    sheetsConfig.isConnected = true;
                    updateSyncStatus();
                    return true;
                }
                
                // Handle successful JSON response
                if (result && typeof result === 'object') {
                    if (result.success === false) {
                        throw new Error(result.error || result.message || 'Apps Script returned error');
                    }
                    
                    if (result.success && result.data) {
                        console.log('✅ Data JSON berjaya diterima dari Google Apps Script');
                        
                        // Load data from Google Sheets with validation
                        if (result.data.shopee && Array.isArray(result.data.shopee)) {
                            data.shopee = result.data.shopee;
                            console.log('📊 Shopee data loaded:', data.shopee.flat().length, 'entries');
                        }
                        if (result.data.bookstore && Array.isArray(result.data.bookstore)) {
                            data.bookstore = result.data.bookstore;
                            console.log('📊 Bookstore data loaded:', data.bookstore.flat().length, 'entries');
                        }
                        if (result.data.purchaseOrder && Array.isArray(result.data.purchaseOrder)) {
                            data.purchaseOrder = result.data.purchaseOrder;
                            console.log('📊 Purchase Order data loaded:', data.purchaseOrder.flat().length, 'entries');
                        }
                        if (result.data.googlePlay && Array.isArray(result.data.googlePlay)) {
                            data.googlePlay = result.data.googlePlay;
                            console.log('📊 Google Play data loaded:', data.googlePlay.flat().length, 'entries');
                        }
                        if (result.data.mindappz && Array.isArray(result.data.mindappz)) {
                            data.mindappz = result.data.mindappz;
                            console.log('📊 Mindappz data loaded:', data.mindappz.flat().length, 'entries');
                        }
                        if (result.data.esentral && Array.isArray(result.data.esentral)) {
                            data.esentral = result.data.esentral;
                            console.log('📊 e-Sentral data loaded:', data.esentral.flat().length, 'entries');
                        }
                        if (result.data.jualanLuar && Array.isArray(result.data.jualanLuar)) {
                            data.jualanLuar = result.data.jualanLuar;
                            console.log('📊 Jualan Luar data loaded:', data.jualanLuar.flat().length, 'entries');
                        }
                        if (result.data.bookCapital && Array.isArray(result.data.bookCapital)) {
                            data.bookCapital = result.data.bookCapital;
                            console.log('📊 Book Capital data loaded:', data.bookCapital.flat().length, 'entries');
                        }
                        if (result.data.siswa && Array.isArray(result.data.siswa)) {
                            data.siswa = result.data.siswa;
                            console.log('📊 Siswa data loaded:', data.siswa.flat().length, 'entries');
                        }
                        if (result.data.invois && Array.isArray(result.data.invois)) {
                            data.invois = result.data.invois;
                            console.log('📊 Invois data loaded:', data.invois.length, 'entries');
                        }
                        
                        // Load Kad Petak Digital data if available
                        if (result.data.books && Array.isArray(result.data.books)) {
                            data.books = result.data.books;
                            console.log('📚 Books data loaded:', data.books.length, 'entries');
                        }
                        if (result.data.transactions && Array.isArray(result.data.transactions)) {
                            data.transactions = result.data.transactions;
                            console.log('📋 Transactions data loaded:', data.transactions.length, 'entries');
                        }
                        
                        sheetsConfig.lastSync = new Date().toISOString();
                        sheetsConfig.isConnected = true;
                        
                        // Also save to localStorage as backup
                        localStorage.setItem('salesData', JSON.stringify(data));
                        localStorage.setItem('lastSyncTime', sheetsConfig.lastSync);
                        
                        updateSyncStatus();
                        console.log('✅ Semua data berjaya dimuat dari Google Sheets!');
                        
                        return true;
                    } else {
                        // No data found, but connection is working
                        console.log('📝 Tiada data dijumpai dalam Google Sheets. Memulakan dengan data kosong.');
                        sheetsConfig.isConnected = true;
                        updateSyncStatus();
                        return true;
                    }
                } else {
                    throw new Error('Invalid response format from Google Apps Script');
                }
                
            } catch (error) {
                console.error('❌ Error loading from Google Sheets:', error);
                
                // Try to load from localStorage as fallback
                const savedData = localStorage.getItem('salesData');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        Object.assign(data, parsedData);
                        console.log('📱 Data dimuat dari localStorage sebagai fallback');
                    } catch (e) {
                        console.error('Error loading from localStorage:', e);
                    }
                }
                
                // Show error but don't fail completely
                if (arguments[0] === 'manual') {
                    alert('⚠️ Gagal memuat dari Google Sheets: ' + error.message + '\n\nMenggunakan data tempatan jika ada.');
                }
                
                return false;
            }
        }
        
        // Parse CSV response from Google Sheets
        function parseCSVResponse(csvText) {
            try {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return null;
                
                // Initialize data structure
                const parsedData = {
                    shopee: Array(12).fill().map(() => []),
                    bookstore: Array(12).fill().map(() => []),
                    purchaseOrder: Array(12).fill().map(() => []),
                    googlePlay: Array(12).fill().map(() => []),
                    mindappz: Array(12).fill().map(() => []),
                    esentral: Array(12).fill().map(() => []),
                    jualanLuar: Array(12).fill().map(() => []),
                    bookCapital: Array(12).fill().map(() => []),
                    siswa: Array(12).fill().map(() => []),
                    invois: []
                };
                
                // Parse header
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                console.log('📋 CSV Headers:', headers);
                
                // Parse data rows
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',').map(cell => cell.replace(/"/g, '').trim());
                    
                    if (row.length < headers.length) continue;
                    
                    const rowData = {};
                    headers.forEach((header, index) => {
                        rowData[header] = row[index] || '';
                    });
                    
                    const category = rowData.Category || '';
                    const subcategory = rowData.Subcategory || '';
                    const month = parseInt(rowData.Month) - 1; // Convert to 0-indexed
                    
                    if (month < 0 || month > 11) continue;
                    
                    // Map data based on category
                    if (category === 'Shopee') {
                        parsedData.shopee[month].push({
                            date: rowData.Date,
                            amount: parseFloat(rowData.Amount) || 0
                        });
                    } else if (category === 'Jualan Fizikal') {
                        if (subcategory === 'Bookstore') {
                            parsedData.bookstore[month].push({
                                date: rowData.Date,
                                qr: parseFloat(rowData.QR) || 0,
                                debit: parseFloat(rowData.Debit) || 0,
                                kredit: parseFloat(rowData.Kredit) || 0
                            });
                        } else if (subcategory === 'Purchase Order') {
                            parsedData.purchaseOrder[month].push({
                                date: rowData.Date,
                                amount: parseFloat(rowData.Amount) || 0,
                                nota: rowData.Nota || ''
                            });
                        }
                    } else if (category === 'eBook') {
                        if (subcategory === 'Google Play') {
                            parsedData.googlePlay[month].push({
                                date: rowData.Date,
                                amount: parseFloat(rowData.Amount) || 0
                            });
                        } else if (subcategory === 'Mindappz') {
                            parsedData.mindappz[month].push({
                                date: rowData.Date,
                                amount: parseFloat(rowData.Amount) || 0
                            });
                        } else if (subcategory === 'e-Sentral') {
                            parsedData.esentral[month].push({
                                date: rowData.Date,
                                amount: parseFloat(rowData.Amount) || 0
                            });
                        }
                    } else if (category === 'Jualan Luar') {
                        parsedData.jualanLuar[month].push({
                            date: rowData.Date,
                            amount: parseFloat(rowData.Amount) || 0,
                            lokasi: rowData.Lokasi || '',
                            nota: rowData.Nota || '',
                            paid: rowData.Paid === 'Yes'
                        });
                    } else if (category === 'Book Capital') {
                        parsedData.bookCapital[month].push({
                            date: rowData.Date,
                            amount: parseFloat(rowData.Amount) || 0,
                            nota: rowData.Nota || '',
                            paid: rowData.Paid === 'Yes'
                        });
                    } else if (category === 'Siswa') {
                        parsedData.siswa[month].push({
                            date: rowData.Date,
                            amount: parseFloat(rowData.Amount) || 0,
                            nota: rowData.Nota || '',
                            paid: rowData.Paid === 'Yes'
                        });
                    } else if (category === 'Bayaran Invois') {
                        try {
                            const extraData = JSON.parse(rowData.Extra_Data || '{}');
                            parsedData.invois.push({
                                bilangan: extraData.bilangan || '',
                                pelanggan: extraData.pelanggan || '',
                                pegawai: extraData.pegawai || '',
                                judul: extraData.judul || '',
                                kuantiti: extraData.kuantiti || '',
                                rujukan: extraData.rujukan || '',
                                tarikhMohon: extraData.tarikhMohon || rowData.Date,
                                jab: extraData.jab || '',
                                tarikhSerah: extraData.tarikhSerah || '',
                                jumlah: parseFloat(rowData.Amount) || 0,
                                invoiceNo: extraData.invoiceNo || null,
                                invoiceDate: extraData.invoiceDate || null,
                                paymentReceived: extraData.paymentReceived || null
                            });
                        } catch (e) {
                            console.warn('Failed to parse invoice extra data:', e);
                        }
                    }
                }
                
                console.log('📊 Parsed data summary:');
                console.log('- Shopee entries:', parsedData.shopee.flat().length);
                console.log('- Bookstore entries:', parsedData.bookstore.flat().length);
                console.log('- Purchase Order entries:', parsedData.purchaseOrder.flat().length);
                console.log('- Google Play entries:', parsedData.googlePlay.flat().length);
                console.log('- Mindappz entries:', parsedData.mindappz.flat().length);
                console.log('- e-Sentral entries:', parsedData.esentral.flat().length);
                console.log('- Jualan Luar entries:', parsedData.jualanLuar.flat().length);
                console.log('- Book Capital entries:', parsedData.bookCapital.flat().length);
                console.log('- Siswa entries:', parsedData.siswa.flat().length);
                console.log('- Invois entries:', parsedData.invois.length);
                
                return parsedData;
                
            } catch (error) {
                console.error('Error parsing CSV:', error);
                return null;
            }
        }
        
        // Save data to localStorage and Google Sheets automatically
        async function saveData() {
            // Always save to localStorage first
            localStorage.setItem('salesData', JSON.stringify(data));
            
            // Always try to sync to Google Sheets if connected
            if (sheetsConfig.isConnected) {
                try {
                    await saveDataToSheets();
                    console.log('✅ Data auto-saved to Google Sheets');
                } catch (error) {
                    console.log('⚠️ Google Sheets sync failed, data saved locally:', error.message);
                }
            }
        }
        
        // Load data from localStorage and Google Sheets
        async function loadData() {
            // Load config from localStorage
            const savedConfig = localStorage.getItem('sheetsConfig');
            if (savedConfig) {
                Object.assign(sheetsConfig, JSON.parse(savedConfig));
            }
            
            // Load data from localStorage first
            const savedData = localStorage.getItem('salesData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(data, parsedData);
                    console.log('Data loaded from localStorage');
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            }
            
            // If connected to Google Sheets, try to load from there too
            if (sheetsConfig.isConnected) {
                try {
                    await loadDataFromSheets();
                    updateSyncStatus();
                } catch (error) {
                    console.error('Error loading from Google Sheets:', error);
                    sheetsConfig.isConnected = false;
                    updateSyncStatus();
                }
            }
        }
        
        // Update sync status display
        function updateSyncStatus() {
            const statusCard = document.getElementById('sync-status-card');
            const statusText = document.getElementById('sync-status-text');
            const lastSyncTime = document.getElementById('last-sync-time');
            
            if (sheetsConfig.isConnected) {
                statusCard.style.display = 'block';
                statusText.textContent = 'Disambung ke Google Apps Script';
                statusText.className = 'text-success';
                
                if (sheetsConfig.lastSync) {
                    const syncDate = new Date(sheetsConfig.lastSync);
                    lastSyncTime.textContent = syncDate.toLocaleString('ms-MY');
                } else {
                    lastSyncTime.textContent = 'Belum pernah sync';
                }
            } else {
                statusCard.style.display = 'none';
            }
        }
        
        // Show sync error
        function showSyncError(message) {
            const statusText = document.getElementById('sync-status-text');
            statusText.textContent = message;
            statusText.className = 'text-danger';
        }
        
        // Save sheets configuration
        function saveSheetsConfig() {
            localStorage.setItem('sheetsConfig', JSON.stringify(sheetsConfig));
        }
        
        // Kad Petak Digital Functions
        
        // Search books function
        function searchBooks(query) {
            if (!query) return [];
            return data.books.filter(book => {
                const title = book.title ? book.title.toString().toLowerCase() : '';
                const isbn = book.isbn ? book.isbn.toString().toLowerCase() : '';
                const searchQuery = query.toLowerCase().trim();
                
                return title.includes(searchQuery) || isbn.includes(searchQuery);
            });
        }
        
        // Add book to selected list
        function addBookToSelectedList(book) {
            const exists = data.selectedBooks.find(b => b.id === book.id);
            if (!exists) {
                data.selectedBooks.push({
                    ...book,
                    transactionType: 'masuk', // masuk or keluar
                    quantity: 1 // Default to 1 instead of 0
                });
                renderSelectedBooksTable();
                
                // Clear search and hide results
                const searchInput = document.getElementById('search-book');
                const searchResults = document.getElementById('search-results');
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.style.display = 'none';
                
                // Show success message
                alert(`✅ "${book.title}" telah ditambah ke senarai!`);
            } else {
                alert(`⚠️ "${book.title}" sudah ada dalam senarai!`);
            }
        }
        
        // Remove book from selected list
        function removeBookFromSelectedList(bookId) {
            data.selectedBooks = data.selectedBooks.filter(b => b.id !== bookId);
            renderSelectedBooksTable();
        }
        
        // Process stock transaction
        function processStockTransaction() {
            const date = document.getElementById('transaction-date').value;
            const grnNumber = document.getElementById('grn-number').value;
            const notes = document.getElementById('transaction-notes').value;
            
            if (!date || data.selectedBooks.length === 0) {
                alert('Sila pilih tarikh dan tambah buku ke senarai!');
                return;
            }
            
            // Validate quantities
            const invalidItems = data.selectedBooks.filter(book => book.quantity <= 0);
            if (invalidItems.length > 0) {
                alert('Sila pastikan semua kuantiti adalah lebih dari 0!');
                return;
            }
            
            const transactionId = Date.now().toString();
            const processedItems = [];
            
            // Process each book in the transaction
            data.selectedBooks.forEach(selectedBook => {
                const book = data.books.find(b => b.id === selectedBook.id);
                if (book) {
                    const oldStock = book.currentStock;
                    
                    if (selectedBook.transactionType === 'masuk') {
                        book.currentStock += selectedBook.quantity;
                    } else {
                        book.currentStock -= selectedBook.quantity;
                        if (book.currentStock < 0) book.currentStock = 0;
                    }
                    
                    // Store processed item info for the main transaction
                    processedItems.push({
                        ...selectedBook,
                        oldStock: oldStock,
                        newStock: book.currentStock
                    });
                    
                    // Add individual transaction record
                    data.transactions.push({
                        id: Date.now() + Math.random(),
                        bookId: book.id,
                        transactionId: transactionId,
                        date: date,
                        grnNumber: grnNumber,
                        type: selectedBook.transactionType,
                        quantity: selectedBook.quantity,
                        balanceAfter: book.currentStock,
                        balanceBefore: oldStock,
                        notes: notes
                    });
                }
            });
            
            // Save main transaction with processed items
            const transaction = {
                id: transactionId,
                date: date,
                grnNumber: grnNumber,
                notes: notes,
                items: processedItems,
                timestamp: new Date().toISOString()
            };
            
            data.transactions.push(transaction);
            
            // Clear selected books
            data.selectedBooks = [];
            
            // Clear form but keep today's date
            document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('grn-number').value = '';
            document.getElementById('transaction-notes').value = '';
            
            // Save data
            saveData();
            
            // Re-render tables
            renderSelectedBooksTable();
            renderRecentTransactionsTable();
            renderAllBooksTable();
            renderLowStockTable();
            
            // Show success message with summary
            const totalItems = processedItems.reduce((sum, item) => sum + item.quantity, 0);
            const masukItems = processedItems.filter(item => item.transactionType === 'masuk').length;
            const keluarItems = processedItems.filter(item => item.transactionType === 'keluar').length;
            
            let summary = `✅ Transaksi berjaya diproses!\n\n`;
            summary += `📊 Ringkasan:\n`;
            summary += `• Jumlah buku: ${processedItems.length}\n`;
            summary += `• Jumlah unit: ${totalItems}\n`;
            if (masukItems > 0) summary += `• Masuk: ${masukItems} buku\n`;
            if (keluarItems > 0) summary += `• Keluar: ${keluarItems} buku\n`;
            summary += `• No. GRN: ${grnNumber || 'Tiada'}\n`;
            
            alert(summary);
        }
        
        // Add new book
        function addNewBook() {
            const title = document.getElementById('new-book-title').value.trim();
            const isbn = document.getElementById('new-book-isbn').value.trim();
            const rak = document.getElementById('new-book-rak').value.trim();
            const quantity = parseInt(document.getElementById('new-book-quantity').value) || 0;
            
            if (!title || !isbn) {
                alert('Sila isi tajuk buku dan ISBN!');
                return;
            }
            
            // Check if book already exists (with proper string validation)
            const exists = data.books.find(book => {
                const bookIsbn = book.isbn ? book.isbn.toString().toLowerCase() : '';
                const bookTitle = book.title ? book.title.toString().toLowerCase() : '';
                const newIsbn = isbn.toLowerCase();
                const newTitle = title.toLowerCase();
                
                return bookIsbn === newIsbn || bookTitle === newTitle;
            });
            
            if (exists) {
                alert('Buku dengan ISBN atau tajuk yang sama sudah wujud!');
                return;
            }
            
            const newBook = {
                id: Date.now().toString(),
                title: title,
                isbn: isbn,
                rak: rak,
                currentStock: quantity,
                initialStock: quantity,
                owner: 'Ajim',
                createdDate: new Date().toISOString()
            };
            
            data.books.push(newBook);
            
            // Add initial stock transaction if quantity > 0
            if (quantity > 0) {
                data.transactions.push({
                    id: Date.now() + Math.random(),
                    bookId: newBook.id,
                    transactionId: 'INITIAL',
                    date: new Date().toISOString().split('T')[0],
                    grnNumber: 'INITIAL',
                    type: 'masuk',
                    quantity: quantity,
                    balanceAfter: quantity,
                    balanceBefore: 0,
                    notes: 'Stok awal'
                });
            }
            
            // Clear form
            document.getElementById('new-book-title').value = '';
            document.getElementById('new-book-isbn').value = '';
            document.getElementById('new-book-rak').value = '';
            document.getElementById('new-book-quantity').value = '';
            
            // Save data
            saveData();
            
            // Re-render tables
            renderAllBooksTable();
            renderLowStockTable();
            
            alert('Buku baru berjaya ditambah!');
        }
        
        // Get book history
        function getBookHistory(bookId) {
            return data.transactions
                .filter(t => t.bookId === bookId && t.transactionId !== 'BATCH')
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        // Get low stock books
        function getLowStockBooks() {
            return data.books.filter(book => book.currentStock < 300);
        }
        
        // Render functions for Kad Petak
        function renderSearchResults(results) {
            const searchResultsDiv = document.getElementById('search-results');
            const tbody = document.getElementById('search-results-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            if (results.length === 0) {
                searchResultsDiv.style.display = 'none';
                return;
            }
            
            searchResultsDiv.style.display = 'block';
            
            results.forEach(book => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${book.title}</td>
                    <td>${book.isbn}</td>
                    <td>${book.rak}</td>
                    <td><strong>${book.currentStock}</strong></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="addBookToSelectedList(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                            <i class="fas fa-plus me-1"></i>Tambah ke Senarai
                        </button>
                    </td>
                `;
            });
        }
        
        function renderSelectedBooksTable() {
            const table = document.getElementById('selected-books-table');
            if (!table) {
                console.log('⚠️ selected-books-table not found, skipping render');
                return;
            }
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.log('⚠️ tbody not found in selected-books-table, skipping render');
                return;
            }
            
            tbody.innerHTML = '';
            
            data.selectedBooks.forEach((book, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${book.title}</td>
                    <td>${book.isbn}</td>
                    <td>${book.currentStock}</td>
                    <td>
                        <select class="form-select form-select-sm" onchange="updateTransactionType(${index}, this.value)">
                            <option value="masuk" ${book.transactionType === 'masuk' ? 'selected' : ''}>Masuk</option>
                            <option value="keluar" ${book.transactionType === 'keluar' ? 'selected' : ''}>Keluar</option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm" value="${book.quantity}" 
                               onchange="updateQuantity(${index}, this.value)" min="0" style="width: 80px;">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="selected-book" data-book-id="${book.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function renderRecentTransactionsTable() {
            const table = document.getElementById('recent-transactions-table');
            if (!table) {
                console.log('⚠️ recent-transactions-table not found, skipping render');
                return;
            }
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.log('⚠️ tbody not found in recent-transactions-table, skipping render');
                return;
            }
            
            tbody.innerHTML = '';
            
            // Get recent batch transactions (not individual book transactions)
            const recentTransactions = data.transactions
                .filter(t => t.items && t.items.length > 0)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            recentTransactions.forEach(transaction => {
                const row = tbody.insertRow();
                const totalItems = transaction.items.reduce((sum, item) => sum + item.quantity, 0);
                const types = [...new Set(transaction.items.map(item => item.transactionType))].join(', ');
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.grnNumber || '-'}</td>
                    <td>${totalItems}</td>
                    <td><span class="badge ${types.includes('masuk') ? 'bg-success' : 'bg-warning'}">${types}</span></td>
                    <td>${transaction.notes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="viewTransactionDetails('${transaction.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="transaction" data-transaction-id="${transaction.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function renderBookHistoryTable(bookId) {
            const tbody = document.getElementById('book-history-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            const history = getBookHistory(bookId);
            
            history.forEach(transaction => {
                const row = tbody.insertRow();
                const typeClass = transaction.type === 'masuk' ? 'bg-success' : 'bg-warning';
                const quantityDisplay = transaction.type === 'masuk' ? `+${transaction.quantity}` : `-${transaction.quantity}`;
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.grnNumber || '-'}</td>
                    <td><span class="badge ${typeClass}">${transaction.type}</span></td>
                    <td>${quantityDisplay}</td>
                    <td>${transaction.balanceAfter}</td>
                    <td>${transaction.notes || '-'}</td>
                `;
            });
        }
        
        function renderBookHistoryTableMain(bookId) {
            const tbody = document.getElementById('book-history-table-main').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            
            const history = getBookHistory(bookId);
            
            history.forEach(transaction => {
                const row = tbody.insertRow();
                const typeClass = transaction.type === 'masuk' ? 'bg-success' : 'bg-warning';
                const quantityDisplay = transaction.type === 'masuk' ? `+${transaction.quantity}` : `-${transaction.quantity}`;
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.grnNumber || '-'}</td>
                    <td><span class="badge ${typeClass}">${transaction.type}</span></td>
                    <td>${quantityDisplay}</td>
                    <td>${transaction.balanceAfter}</td>
                    <td>${transaction.notes || '-'}</td>
                `;
            });
        }
        
        function renderAllBooksTable() {
            const table = document.getElementById('all-books-table');
            if (!table) {
                console.log('⚠️ all-books-table not found, skipping render');
                return;
            }
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.log('⚠️ tbody not found in all-books-table, skipping render');
                return;
            }
            
            tbody.innerHTML = '';
            
            data.books.forEach(book => {
                const row = tbody.insertRow();
                let statusBadge = 'bg-success';
                let statusText = 'Normal';
                
                if (book.currentStock < 100) {
                    statusBadge = 'bg-danger';
                    statusText = 'Kritikal';
                } else if (book.currentStock < 300) {
                    statusBadge = 'bg-warning';
                    statusText = 'Terhad';
                }
                
                row.innerHTML = `
                    <td>${book.title}</td>
                    <td>${book.isbn}</td>
                    <td>${book.rak}</td>
                    <td>${book.currentStock}</td>
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="viewBookHistory('${book.id}')">
                            <i class="fas fa-history"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1" onclick="addBookToSelectedList(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-type="book" data-book-id="${book.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }
        
        function renderLowStockTable() {
            const table = document.getElementById('low-stock-table');
            if (!table) {
                console.log('⚠️ low-stock-table not found, skipping render');
                return;
            }
            
            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.log('⚠️ tbody not found in low-stock-table, skipping render');
                return;
            }
            
            tbody.innerHTML = '';
            
            const lowStockBooks = getLowStockBooks();
            let terhad = 0, kritikal = 0;
            
            lowStockBooks.forEach(book => {
                const row = tbody.insertRow();
                let statusBadge = 'bg-warning';
                let statusText = 'Terhad';
                
                if (book.currentStock < 100) {
                    statusBadge = 'bg-danger';
                    statusText = 'Kritikal';
                    kritikal++;
                } else {
                    terhad++;
                }
                
                row.innerHTML = `
                    <td><span class="badge ${statusBadge}">${statusText}</span></td>
                    <td>${book.title}</td>
                    <td>${book.isbn}</td>
                    <td>${book.rak}</td>
                    <td><strong>${book.currentStock}</strong></td>
                `;
            });
            
            // Update counters
            const terhadCount = document.getElementById('terhad-count');
            const kritikalCount = document.getElementById('kritikal-count');
            if (terhadCount) terhadCount.textContent = terhad;
            if (kritikalCount) kritikalCount.textContent = kritikal;
        }
        
        // Helper functions for Kad Petak
        function updateTransactionType(index, type) {
            data.selectedBooks[index].transactionType = type;
        }
        
        function updateQuantity(index, quantity) {
            data.selectedBooks[index].quantity = parseInt(quantity) || 0;
        }
        
        function hideBookDetails() {
            document.getElementById('book-details-card').style.display = 'none';
            document.getElementById('book-history-table').getElementsByTagName('tbody')[0].innerHTML = '';
        }
        
        function hideBookDetailsMain() {
            document.getElementById('book-details-card-main').style.display = 'none';
            document.getElementById('book-history-table-main').getElementsByTagName('tbody')[0].innerHTML = '';
        }
        
        function viewBookHistory(bookId) {
            const book = data.books.find(b => b.id === bookId);
            if (!book) return;
            
            // Update book details card
            document.getElementById('book-title').textContent = book.title;
            document.getElementById('book-isbn').textContent = book.isbn;
            document.getElementById('book-rak').textContent = book.rak;
            document.getElementById('book-balance').textContent = book.currentStock;
            document.getElementById('book-owner').textContent = book.owner;
            
            // Show book details card
            document.getElementById('book-details-card').style.display = 'block';
            
            // Render history table
            renderBookHistoryTable(bookId);
            
            // Switch to history tab
            const historyTab = new bootstrap.Tab(document.getElementById('sejarah-tab'));
            historyTab.show();
        }
        
        function viewBookHistoryMain(bookId) {
            const book = data.books.find(b => b.id === bookId);
            if (!book) return;
            
            // Update book details card for main tab
            document.getElementById('book-title-main').textContent = book.title;
            document.getElementById('book-isbn-main').textContent = book.isbn;
            document.getElementById('book-rak-main').textContent = book.rak;
            document.getElementById('book-balance-main').textContent = book.currentStock;
            document.getElementById('book-owner-main').textContent = book.owner;
            
            // Show book details card
            document.getElementById('book-details-card-main').style.display = 'block';
            
            // Render history table for main tab
            renderBookHistoryTableMain(bookId);
        }
        

        
        function viewTransactionDetails(transactionId) {
            const transaction = data.transactions.find(t => t.id === transactionId);
            if (!transaction) {
                alert('Transaksi tidak dijumpai!');
                return;
            }
            
            let details = `📅 Tarikh: ${formatDate(transaction.date)}\n`;
            details += `📋 No. GRN: ${transaction.grnNumber || '-'}\n`;
            details += `📝 Nota: ${transaction.notes || '-'}\n\n`;
            details += `📚 Senarai Buku (${transaction.items ? transaction.items.length : 0} item):\n`;
            details += `${'='.repeat(50)}\n`;
            
            if (transaction.items && transaction.items.length > 0) {
                transaction.items.forEach((item, index) => {
                    const typeIcon = item.transactionType === 'masuk' ? '📥' : '📤';
                    const typeText = item.transactionType === 'masuk' ? 'MASUK' : 'KELUAR';
                    details += `${index + 1}. ${item.title}\n`;
                    details += `   ISBN: ${item.isbn}\n`;
                    details += `   ${typeIcon} ${typeText}: ${item.quantity} unit\n`;
                    details += `   Stok Sebelum: ${item.oldStock}\n`;
                    details += `   Stok Selepas: ${item.newStock}\n\n`;
                });
            } else {
                details += `Tiada maklumat item untuk transaksi ini.\n`;
            }
            
            details += `${'='.repeat(50)}\n`;
            details += `⏰ Diproses pada: ${new Date(transaction.timestamp || transaction.date).toLocaleString('ms-MY')}`;
            
            alert(details);
        }

        // Initialize the application
        function init() {
            // Load saved data
            loadData();
            
            // Set up event listeners for month selection
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.shopee = month;
                    
                    // Update active state
                    document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.bookstore-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.bookstore = month;
                    
                    // Update active state
                    document.querySelectorAll('.bookstore-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.po-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.purchaseOrder = month;
                    
                    // Update active state
                    document.querySelectorAll('.po-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.gplay-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.googlePlay = month;
                    
                    // Update active state
                    document.querySelectorAll('.gplay-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.mindappz-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.mindappz = month;
                    
                    // Update active state
                    document.querySelectorAll('.mindappz-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.esentral-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.esentral = month;
                    
                    // Update active state
                    document.querySelectorAll('.esentral-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.jl-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.jualanLuar = month;
                    
                    // Update active state
                    document.querySelectorAll('.jl-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.bc-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.bookCapital = month;
                    
                    // Update active state
                    document.querySelectorAll('.bc-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            document.querySelectorAll('.siswa-month-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const month = parseInt(this.getAttribute('data-month')) - 1;
                    currentMonth.siswa = month;
                    
                    // Update active state
                    document.querySelectorAll('.siswa-month-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Re-render tables and update totals
                    renderTables();
                    calculateMonthlyTotals();
                });
            });
            
            // Set up event listeners for save buttons
            document.getElementById('shopee-save').addEventListener('click', function() {
                const date = document.getElementById('shopee-date').value;
                const amount = parseFloat(document.getElementById('shopee-amount').value) || 0;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.shopee[currentMonth.shopee].push({
                    date: date,
                    amount: amount
                });
                
                // Clear form
                document.getElementById('shopee-date').value = '';
                document.getElementById('shopee-amount').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('bookstore-save').addEventListener('click', function() {
                const date = document.getElementById('bookstore-date').value;
                const qr = parseFloat(document.getElementById('bookstore-qr').value) || 0;
                const debit = parseFloat(document.getElementById('bookstore-debit').value) || 0;
                const kredit = parseFloat(document.getElementById('bookstore-kredit').value) || 0;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.bookstore[currentMonth.bookstore].push({
                    date: date,
                    qr: qr,
                    debit: debit,
                    kredit: kredit
                });
                
                // Clear form
                document.getElementById('bookstore-date').value = '';
                document.getElementById('bookstore-qr').value = '';
                document.getElementById('bookstore-debit').value = '';
                document.getElementById('bookstore-kredit').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('po-save').addEventListener('click', function() {
                const date = document.getElementById('po-date').value;
                const amount = parseFloat(document.getElementById('po-amount').value) || 0;
                const nota = document.getElementById('po-nota').value;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.purchaseOrder[currentMonth.purchaseOrder].push({
                    date: date,
                    amount: amount,
                    nota: nota
                });
                
                // Clear form
                document.getElementById('po-date').value = '';
                document.getElementById('po-amount').value = '';
                document.getElementById('po-nota').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('gplay-save').addEventListener('click', function() {
                const date = document.getElementById('gplay-date').value;
                const amount = parseFloat(document.getElementById('gplay-amount').value) || 0;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.googlePlay[currentMonth.googlePlay].push({
                    date: date,
                    amount: amount
                });
                
                // Clear form
                document.getElementById('gplay-date').value = '';
                document.getElementById('gplay-amount').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('mindappz-save').addEventListener('click', function() {
                const date = document.getElementById('mindappz-date').value;
                const amount = parseFloat(document.getElementById('mindappz-amount').value) || 0;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.mindappz[currentMonth.mindappz].push({
                    date: date,
                    amount: amount
                });
                
                // Clear form
                document.getElementById('mindappz-date').value = '';
                document.getElementById('mindappz-amount').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('esentral-save').addEventListener('click', function() {
                const date = document.getElementById('esentral-date').value;
                const amount = parseFloat(document.getElementById('esentral-amount').value) || 0;
                
                if (!date) {
                    alert('Sila pilih tarikh!');
                    return;
                }
                
                data.esentral[currentMonth.esentral].push({
                    date: date,
                    amount: amount
                });
                
                // Clear form
                document.getElementById('esentral-date').value = '';
                document.getElementById('esentral-amount').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('jl-save').addEventListener('click', function() {
                const date = document.getElementById('jl-date').value;
                const amount = parseFloat(document.getElementById('jl-amount').value) || 0;
                const lokasi = document.getElementById('jl-lokasi').value;
                const nota = document.getElementById('jl-nota').value;
                
                if (!date || !amount) {
                    alert('Sila pilih tarikh dan masukkan jumlah!');
                    return;
                }
                
                data.jualanLuar[currentMonth.jualanLuar].push({
                    date: date,
                    amount: amount,
                    lokasi: lokasi,
                    nota: nota,
                    paid: false
                });
                
                // Clear form
                document.getElementById('jl-date').value = '';
                document.getElementById('jl-amount').value = '';
                document.getElementById('jl-lokasi').value = '';
                document.getElementById('jl-nota').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('bc-save').addEventListener('click', function() {
                const date = document.getElementById('bc-date').value;
                const amount = parseFloat(document.getElementById('bc-amount').value) || 0;
                const nota = document.getElementById('bc-nota').value;
                
                if (!date || !amount) {
                    alert('Sila pilih tarikh dan masukkan jumlah!');
                    return;
                }
                
                data.bookCapital[currentMonth.bookCapital].push({
                    date: date,
                    amount: amount,
                    nota: nota,
                    paid: false
                });
                
                // Clear form
                document.getElementById('bc-date').value = '';
                document.getElementById('bc-amount').value = '';
                document.getElementById('bc-nota').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('siswa-save').addEventListener('click', function() {
                const date = document.getElementById('siswa-date').value;
                const amount = parseFloat(document.getElementById('siswa-amount').value) || 0;
                const nota = document.getElementById('siswa-nota').value;
                
                if (!date || !amount) {
                    alert('Sila pilih tarikh dan masukkan jumlah!');
                    return;
                }
                
                data.siswa[currentMonth.siswa].push({
                    date: date,
                    amount: amount,
                    nota: nota,
                    paid: false
                });
                
                // Clear form
                document.getElementById('siswa-date').value = '';
                document.getElementById('siswa-amount').value = '';
                document.getElementById('siswa-nota').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('inv-add').addEventListener('click', function() {
                const bilangan = document.getElementById('inv-bilangan').value;
                const pelanggan = document.getElementById('inv-pelanggan').value;
                const pegawai = document.getElementById('inv-pegawai').value;
                const judul = document.getElementById('inv-judul').value;
                const kuantiti = document.getElementById('inv-kuantiti').value;
                const rujukan = document.getElementById('inv-rujukan').value;
                const tarikhMohon = document.getElementById('inv-tarikh-mohon').value;
                const jab = document.getElementById('inv-jab').value;
                const tarikhSerah = document.getElementById('inv-tarikh-serah').value;
                const jumlah = parseFloat(document.getElementById('inv-jumlah').value) || 0;
                
                if (!bilangan || !pelanggan || !judul || !kuantiti || !tarikhMohon || !jumlah) {
                    alert('Sila isi semua maklumat penting!');
                    return;
                }
                
                data.invois.push({
                    bilangan: bilangan,
                    pelanggan: pelanggan,
                    pegawai: pegawai,
                    judul: judul,
                    kuantiti: kuantiti,
                    rujukan: rujukan,
                    tarikhMohon: tarikhMohon,
                    jab: jab,
                    tarikhSerah: tarikhSerah,
                    jumlah: jumlah,
                    paymentReceived: null,
                    invoiceNo: null,
                    invoiceDate: null
                });
                
                // Clear form
                document.getElementById('inv-bilangan').value = '';
                document.getElementById('inv-pelanggan').value = '';
                document.getElementById('inv-pegawai').value = '';
                document.getElementById('inv-judul').value = '';
                document.getElementById('inv-kuantiti').value = '';
                document.getElementById('inv-rujukan').value = '';
                document.getElementById('inv-tarikh-mohon').value = '';
                document.getElementById('inv-jab').value = '';
                document.getElementById('inv-tarikh-serah').value = '';
                document.getElementById('inv-jumlah').value = '';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('inv-save-payment').addEventListener('click', function() {
                const index = parseInt(document.getElementById('inv-payment-id').value);
                const invoiceNo = document.getElementById('inv-no').value;
                const invoiceDate = document.getElementById('inv-tarikh').value;
                const paymentReceived = parseFloat(document.getElementById('inv-bayaran').value) || 0;
                
                if (!invoiceNo || !invoiceDate || !paymentReceived) {
                    alert('Sila isi semua maklumat pembayaran!');
                    return;
                }
                
                data.invois[index].invoiceNo = invoiceNo;
                data.invois[index].invoiceDate = invoiceDate;
                data.invois[index].paymentReceived = paymentReceived;
                
                // Clear form and hide it
                document.getElementById('inv-no').value = '';
                document.getElementById('inv-tarikh').value = '';
                document.getElementById('inv-bayaran').value = '';
                document.getElementById('inv-payment-form').style.display = 'none';
                
                // Save data to localStorage
                saveData();
                
                // Re-render tables and update totals
                renderTables();
                calculateMonthlyTotals();
            });
            
            document.getElementById('inv-cancel-payment').addEventListener('click', function() {
                // Clear form and hide it
                document.getElementById('inv-no').value = '';
                document.getElementById('inv-tarikh').value = '';
                document.getElementById('inv-bayaran').value = '';
                document.getElementById('inv-payment-form').style.display = 'none';
            });
            
            // Initial render
            renderTables();
            calculateMonthlyTotals();
            
            // Render Kad Petak tables (only if elements exist)
            setTimeout(() => {
                renderSelectedBooksTable();
                renderRecentTransactionsTable();
                renderAllBooksTable();
                renderLowStockTable();
            }, 100);
        }
        
        // PDF Export functionality
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set up document properties
            doc.setProperties({
                title: 'Laporan Jualan Lengkap',
                subject: 'Complete Sales Report',
                author: 'SalesPro System',
                creator: 'SalesPro System'
            });
            
            // Add title
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('LAPORAN JUALAN LENGKAP', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            const currentDate = new Date().toLocaleDateString('ms-MY');
            doc.text(`Tarikh: ${currentDate}`, 20, 35);
            
            let yPosition = 50;
            
            // Calculate totals
            const shopeeTotals = data.shopee.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const bookstoreTotals = data.bookstore.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.qr || 0) + parseFloat(item.debit || 0) + parseFloat(item.kredit || 0), 0)
            );
            const poTotals = data.purchaseOrder.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const gplayTotals = data.googlePlay.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const mindappzTotals = data.mindappz.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const esentralTotals = data.esentral.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const jlTotals = data.jualanLuar.map(month => 
                month.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0)
            );
            const bcTotals = data.bookCapital.map(month => 
                month.reduce((sum, item) => sum + (item.paid ? parseFloat(item.amount || 0) : 0), 0)
            );
            const siswaTotals = data.siswa.map(month => 
                month.reduce((sum, item) => sum + (item.paid ? parseFloat(item.amount || 0) : 0), 0)
            );
            
            const fizikalTotals = bookstoreTotals.map((val, idx) => val + poTotals[idx]);
            const ebookTotals = gplayTotals.map((val, idx) => val + mindappzTotals[idx] + esentralTotals[idx]);
            const invoisTotal = data.invois
                .filter(item => item.paymentReceived)
                .reduce((sum, item) => sum + parseFloat(item.paymentReceived || 0), 0);
            
            // Summary section
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RINGKASAN JUALAN', 20, yPosition);
            yPosition += 15;
            
            const summaryData = [
                ['Shopee', formatCurrency(shopeeTotals.reduce((sum, val) => sum + val, 0))],
                ['Jualan Fizikal', formatCurrency(fizikalTotals.reduce((sum, val) => sum + val, 0))],
                ['  - Bookstore', formatCurrency(bookstoreTotals.reduce((sum, val) => sum + val, 0))],
                ['  - Purchase Order', formatCurrency(poTotals.reduce((sum, val) => sum + val, 0))],
                ['eBook', formatCurrency(ebookTotals.reduce((sum, val) => sum + val, 0))],
                ['  - Google Play', formatCurrency(gplayTotals.reduce((sum, val) => sum + val, 0))],
                ['  - Mindappz', formatCurrency(mindappzTotals.reduce((sum, val) => sum + val, 0))],
                ['  - e-Sentral', formatCurrency(esentralTotals.reduce((sum, val) => sum + val, 0))],
                ['Jualan Luar', formatCurrency(jlTotals.reduce((sum, val) => sum + val, 0))],
                ['Book Capital', formatCurrency(bcTotals.reduce((sum, val) => sum + val, 0))],
                ['Siswa', formatCurrency(siswaTotals.reduce((sum, val) => sum + val, 0))],
                ['Bayaran Invois', formatCurrency(invoisTotal)]
            ];
            
            const grandTotal = shopeeTotals.reduce((sum, val) => sum + val, 0) +
                              fizikalTotals.reduce((sum, val) => sum + val, 0) +
                              ebookTotals.reduce((sum, val) => sum + val, 0) +
                              jlTotals.reduce((sum, val) => sum + val, 0) +
                              bcTotals.reduce((sum, val) => sum + val, 0) +
                              siswaTotals.reduce((sum, val) => sum + val, 0) +
                              invoisTotal;
            
            summaryData.push(['', '']);
            summaryData.push(['JUMLAH KESELURUHAN', formatCurrency(grandTotal)]);
            
            doc.autoTable({
                startY: yPosition,
                head: [['Kategori', 'Jumlah (RM)']],
                body: summaryData,
                theme: 'grid',
                headStyles: { fillColor: [108, 92, 231] },
                styles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 60, halign: 'right' }
                }
            });
            
            yPosition = doc.lastAutoTable.finalY + 20;
            
            // Monthly breakdown
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('PECAHAN BULANAN', 20, yPosition);
            yPosition += 15;
            
            const months = ['Jan', 'Feb', 'Mac', 'Apr', 'Mei', 'Jun', 'Jul', 'Ogos', 'Sept', 'Okt', 'Nov', 'Dis'];
            const monthlyData = [];
            
            for (let i = 0; i < 12; i++) {
                const monthTotal = shopeeTotals[i] + fizikalTotals[i] + ebookTotals[i] + jlTotals[i] + bcTotals[i] + siswaTotals[i];
                monthlyData.push([
                    months[i],
                    formatCurrency(shopeeTotals[i]),
                    formatCurrency(fizikalTotals[i]),
                    formatCurrency(ebookTotals[i]),
                    formatCurrency(jlTotals[i]),
                    formatCurrency(bcTotals[i]),
                    formatCurrency(siswaTotals[i]),
                    formatCurrency(monthTotal)
                ]);
            }
            
            doc.autoTable({
                startY: yPosition,
                head: [['Bulan', 'Shopee', 'Fizikal', 'eBook', 'Jualan Luar', 'Book Capital', 'Siswa', 'Jumlah']],
                body: monthlyData,
                theme: 'grid',
                headStyles: { fillColor: [108, 92, 231] },
                styles: { fontSize: 8 },
                columnStyles: {
                    0: { cellWidth: 20 },
                    1: { cellWidth: 22, halign: 'right' },
                    2: { cellWidth: 22, halign: 'right' },
                    3: { cellWidth: 22, halign: 'right' },
                    4: { cellWidth: 22, halign: 'right' },
                    5: { cellWidth: 22, halign: 'right' },
                    6: { cellWidth: 22, halign: 'right' },
                    7: { cellWidth: 26, halign: 'right' }
                }
            });
            
            // Helper function to add section with transactions
            function addTransactionSection(title, dataArray, columns, monthNames) {
                doc.addPage();
                yPosition = 20;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(title, 20, yPosition);
                yPosition += 15;
                
                let hasData = false;
                
                for (let monthIndex = 0; monthIndex < 12; monthIndex++) {
                    const monthData = dataArray[monthIndex];
                    if (monthData && monthData.length > 0) {
                        hasData = true;
                        
                        // Check if we need a new page
                        if (yPosition > 250) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        doc.text(`${monthNames[monthIndex]} ${new Date().getFullYear()}`, 20, yPosition);
                        yPosition += 10;
                        
                        const tableData = monthData.map(item => {
                            const row = [];
                            columns.forEach(col => {
                                if (col.key === 'date') {
                                    row.push(formatDate(item[col.key]));
                                } else if (col.key === 'total') {
                                    // Calculate total for bookstore
                                    const total = parseFloat(item.qr || 0) + parseFloat(item.debit || 0) + parseFloat(item.kredit || 0);
                                    row.push(formatCurrency(total));
                                } else if (col.key === 'status') {
                                    // Show payment status
                                    const status = item.paid ? 'Dibayar' : 'Belum Dibayar';
                                    row.push(status);
                                } else if (col.type === 'currency') {
                                    row.push(formatCurrency(item[col.key] || 0));
                                } else {
                                    row.push(item[col.key] || '-');
                                }
                            });
                            return row;
                        });
                        
                        doc.autoTable({
                            startY: yPosition,
                            head: [columns.map(col => col.header)],
                            body: tableData,
                            theme: 'striped',
                            headStyles: { fillColor: [108, 92, 231] },
                            styles: { fontSize: 9 },
                            margin: { left: 20, right: 20 }
                        });
                        
                        yPosition = doc.lastAutoTable.finalY + 15;
                    }
                }
                
                if (!hasData) {
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    doc.text('Tiada data untuk kategori ini.', 20, yPosition);
                }
            }
            
            // 1. SHOPEE REPORT
            addTransactionSection('LAPORAN SHOPEE', data.shopee, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' }
            ], months);
            
            // 2. BOOKSTORE REPORT
            addTransactionSection('LAPORAN BOOKSTORE', data.bookstore, [
                { header: 'Tarikh', key: 'date' },
                { header: 'QR (RM)', key: 'qr', type: 'currency' },
                { header: 'Debit (RM)', key: 'debit', type: 'currency' },
                { header: 'Kredit (RM)', key: 'kredit', type: 'currency' },
                { header: 'Jumlah (RM)', key: 'total', type: 'currency' }
            ], months);
            
            // 3. PURCHASE ORDER REPORT
            addTransactionSection('LAPORAN PURCHASE ORDER', data.purchaseOrder, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' },
                { header: 'Nota', key: 'nota' }
            ], months);
            
            // 4. GOOGLE PLAY REPORT
            addTransactionSection('LAPORAN GOOGLE PLAY', data.googlePlay, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' }
            ], months);
            
            // 5. MINDAPPZ REPORT
            addTransactionSection('LAPORAN MINDAPPZ', data.mindappz, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' }
            ], months);
            
            // 6. E-SENTRAL REPORT
            addTransactionSection('LAPORAN E-SENTRAL', data.esentral, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' }
            ], months);
            
            // 7. JUALAN LUAR REPORT
            addTransactionSection('LAPORAN JUALAN LUAR', data.jualanLuar, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' },
                { header: 'Lokasi', key: 'lokasi' },
                { header: 'Nota', key: 'nota' },
                { header: 'Status', key: 'status' }
            ], months);
            
            // 8. BOOK CAPITAL REPORT
            addTransactionSection('LAPORAN BOOK CAPITAL', data.bookCapital, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' },
                { header: 'Nota', key: 'nota' },
                { header: 'Status', key: 'status' }
            ], months);
            
            // 9. SISWA REPORT
            addTransactionSection('LAPORAN SISWA', data.siswa, [
                { header: 'Tarikh', key: 'date' },
                { header: 'Jumlah (RM)', key: 'amount', type: 'currency' },
                { header: 'Nota', key: 'nota' },
                { header: 'Status', key: 'status' }
            ], months);
            
            // 10. BAYARAN INVOIS REPORT
            if (data.invois.length > 0) {
                doc.addPage();
                yPosition = 20;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('LAPORAN BAYARAN INVOIS', 20, yPosition);
                yPosition += 15;
                
                const invoiceData = data.invois.map(item => [
                    item.bilangan || '-',
                    item.pelanggan || '-',
                    item.pegawai || '-',
                    item.judul || '-',
                    item.kuantiti || '-',
                    item.rujukan || '-',
                    formatDate(item.tarikhMohon),
                    item.jab || '-',
                    formatDate(item.tarikhSerah),
                    formatCurrency(item.jumlah || 0),
                    item.paymentReceived ? 'Dibayar' : 'Belum Dibayar',
                    item.invoiceNo || '-',
                    formatDate(item.invoiceDate),
                    item.paymentReceived ? formatCurrency(item.paymentReceived) : '-'
                ]);
                
                doc.autoTable({
                    startY: yPosition,
                    head: [['Bil.', 'Pelanggan', 'Pegawai', 'Judul', 'Kuantiti', 'Rujukan', 'Tarikh Mohon', 'JAB/UKZ/CWG', 'Tarikh Serah', 'Jumlah', 'Status', 'No. Invois', 'Tarikh Invois', 'Bayaran']],
                    body: invoiceData,
                    theme: 'striped',
                    headStyles: { fillColor: [108, 92, 231] },
                    styles: { fontSize: 7 },
                    columnStyles: {
                        0: { cellWidth: 12 },
                        1: { cellWidth: 15 },
                        2: { cellWidth: 15 },
                        3: { cellWidth: 20 },
                        4: { cellWidth: 10, halign: 'center' },
                        5: { cellWidth: 12 },
                        6: { cellWidth: 15 },
                        7: { cellWidth: 15 },
                        8: { cellWidth: 15 },
                        9: { cellWidth: 15, halign: 'right' },
                        10: { cellWidth: 12, halign: 'center' },
                        11: { cellWidth: 12 },
                        12: { cellWidth: 15 },
                        13: { cellWidth: 15, halign: 'right' }
                    }
                });
            } else {
                doc.addPage();
                yPosition = 20;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('LAPORAN BAYARAN INVOIS', 20, yPosition);
                yPosition += 15;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Tiada data invois untuk dipaparkan.', 20, yPosition);
            }
            
            // Add footer to all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Halaman ${i} dari ${pageCount}`, 105, 285, { align: 'center' });
                doc.text('Penerbit UiTM', 105, 290, { align: 'center' });
            }
            
            // Save the PDF
            const fileName = `Laporan_Lengkap_${new Date().getFullYear()}_${currentDate.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // Add event listener for PDF export
            document.getElementById('export-pdf-btn').addEventListener('click', function() {
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
                this.disabled = true;
                
                // Small delay to show loading state
                setTimeout(() => {
                    try {
                        exportToPDF();
                        this.innerHTML = '<i class="fas fa-file-pdf me-2"></i>Export PDF Report';
                        this.disabled = false;
                    } catch (error) {
                        alert('Ralat semasa menjana PDF. Sila cuba lagi.');
                        this.innerHTML = '<i class="fas fa-file-pdf me-2"></i>Export PDF Report';
                        this.disabled = false;
                    }
                }, 100);
            });
            
            // Set up Kad Petak event listeners
            
            // Search book functionality
            document.getElementById('search-book').addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length === 0) {
                    // Hide search results when input is empty
                    document.getElementById('search-results').style.display = 'none';
                    return;
                }
                
                if (query.length >= 2) {
                    const results = searchBooks(query);
                    renderSearchResults(results);
                }
            });
            
            // Process transaction
            document.getElementById('process-transaction').addEventListener('click', processStockTransaction);
            
            // Search book history with improved auto-search functionality
            document.getElementById('search-book-history').addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length >= 3) { // Minimum 3 characters to start searching
                    const results = searchBooks(query);
                    
                    // Only auto-show if there's exactly one result and query is specific enough (5+ characters)
                    if (results.length === 1 && query.length >= 5) {
                        viewBookHistory(results[0].id);
                    } else if (results.length === 0) {
                        // Hide book details if no results
                        hideBookDetails();
                    } else if (results.length > 1) {
                        // Multiple results found - hide auto-display, wait for manual search
                        hideBookDetails();
                    }
                } else if (query.length === 0) {
                    // Hide book details when search is cleared
                    hideBookDetails();
                }
            });
            
            // Manual search button (for multiple results)
            document.getElementById('view-book-history').addEventListener('click', function() {
                const query = document.getElementById('search-book-history').value.trim();
                if (!query) {
                    alert('Sila masukkan nama buku untuk dicari!');
                    return;
                }
                
                const results = searchBooks(query);
                if (results.length === 0) {
                    alert(`Buku tidak dijumpai untuk carian: "${query}"\n\nTip: Cuba cari dengan:\n• Sebahagian tajuk buku\n• Nombor ISBN\n• Pastikan ejaan betul`);
                    hideBookDetails();
                    return;
                }
                
                if (results.length === 1) {
                    viewBookHistory(results[0].id);
                } else {
                    // If multiple results, show selection with better formatting
                    let options = `Dijumpai ${results.length} buku untuk carian "${query}":\n\n`;
                    results.forEach((book, index) => {
                        options += `${index + 1}. ${book.title}\n`;
                        options += `   ISBN: ${book.isbn}\n`;
                        options += `   Rak: ${book.rak}\n`;
                        options += `   Stok: ${book.currentStock}\n\n`;
                    });
                    
                    const choice = prompt(options + 'Masukkan nombor pilihan (1-' + results.length + '):');
                    const choiceIndex = parseInt(choice) - 1;
                    
                    if (choiceIndex >= 0 && choiceIndex < results.length) {
                        viewBookHistory(results[choiceIndex].id);
                    } else if (choice !== null) {
                        alert('Pilihan tidak sah. Sila masukkan nombor antara 1 hingga ' + results.length);
                    } else {
                        // User cancelled - hide book details
                        hideBookDetails();
                    }
                }
            });

            // Search book history for main Kad Petak tab
            document.getElementById('search-book-history-main').addEventListener('input', function() {
                const query = this.value.trim();
                
                if (query.length >= 3) { // Minimum 3 characters to start searching
                    const results = searchBooks(query);
                    
                    // Only auto-show if there's exactly one result and query is specific enough (5+ characters)
                    if (results.length === 1 && query.length >= 5) {
                        viewBookHistoryMain(results[0].id);
                    } else if (results.length === 0) {
                        // Hide book details if no results
                        hideBookDetailsMain();
                    } else if (results.length > 1) {
                        // Multiple results found - hide auto-display, wait for manual search
                        hideBookDetailsMain();
                    }
                } else if (query.length === 0) {
                    // Hide book details when search is cleared
                    hideBookDetailsMain();
                }
            });
            
            // Manual search button for main Kad Petak tab
            document.getElementById('view-book-history-main').addEventListener('click', function() {
                const query = document.getElementById('search-book-history-main').value.trim();
                if (!query) {
                    alert('Sila masukkan nama buku untuk dicari!');
                    return;
                }
                
                const results = searchBooks(query);
                if (results.length === 0) {
                    alert(`Buku tidak dijumpai untuk carian: "${query}"\n\nTip: Cuba cari dengan:\n• Sebahagian tajuk buku\n• Nombor ISBN\n• Pastikan ejaan betul`);
                    hideBookDetailsMain();
                    return;
                }
                
                if (results.length === 1) {
                    viewBookHistoryMain(results[0].id);
                } else {
                    // If multiple results, show selection with better formatting
                    let options = `Dijumpai ${results.length} buku untuk carian "${query}":\n\n`;
                    results.forEach((book, index) => {
                        options += `${index + 1}. ${book.title}\n`;
                        options += `   ISBN: ${book.isbn}\n`;
                        options += `   Rak: ${book.rak}\n`;
                        options += `   Stok: ${book.currentStock}\n\n`;
                    });
                    
                    const choice = prompt(options + 'Masukkan nombor pilihan (1-' + results.length + '):');
                    const choiceIndex = parseInt(choice) - 1;
                    
                    if (choiceIndex >= 0 && choiceIndex < results.length) {
                        viewBookHistoryMain(results[choiceIndex].id);
                    } else if (choice !== null) {
                        alert('Pilihan tidak sah. Sila masukkan nombor antara 1 hingga ' + results.length);
                    } else {
                        // User cancelled - hide book details
                        hideBookDetailsMain();
                    }
                }
            });
            
            // Add new book
            document.getElementById('add-new-book').addEventListener('click', function() {
                const title = document.getElementById('new-book-title').value.trim();
                const isbn = document.getElementById('new-book-isbn').value.trim();
                const rak = document.getElementById('new-book-rak').value.trim();
                const quantity = parseInt(document.getElementById('new-book-quantity').value) || 0;
                
                if (!title || !isbn) {
                    alert('Sila isi tajuk buku dan ISBN!');
                    return;
                }
                
                // Check if book already exists (with proper string validation)
                const exists = data.books.find(book => {
                    const bookIsbn = book.isbn ? book.isbn.toString().toLowerCase() : '';
                    const bookTitle = book.title ? book.title.toString().toLowerCase() : '';
                    const newIsbn = isbn.toLowerCase();
                    const newTitle = title.toLowerCase();
                    
                    return bookIsbn === newIsbn || bookTitle === newTitle;
                });
                
                if (exists) {
                    alert('Buku dengan ISBN atau tajuk yang sama sudah wujud!');
                    return;
                }
                
                const newBook = {
                    id: Date.now().toString(),
                    title: title,
                    isbn: isbn,
                    rak: rak,
                    currentStock: quantity,
                    initialStock: quantity,
                    owner: 'Ajim',
                    createdDate: new Date().toISOString()
                };
                
                data.books.push(newBook);
                
                // Add initial stock transaction if quantity > 0
                if (quantity > 0) {
                    data.transactions.push({
                        id: Date.now() + Math.random(),
                        bookId: newBook.id,
                        transactionId: 'INITIAL',
                        date: new Date().toISOString().split('T')[0],
                        grnNumber: 'INITIAL',
                        type: 'masuk',
                        quantity: quantity,
                        balanceAfter: quantity,
                        balanceBefore: 0,
                        notes: 'Stok awal'
                    });
                }
                
                // Clear form
                document.getElementById('new-book-title').value = '';
                document.getElementById('new-book-isbn').value = '';
                document.getElementById('new-book-rak').value = '';
                document.getElementById('new-book-quantity').value = '';
                
                // Save data
                saveData();
                
                // Re-render tables
                renderAllBooksTable();
                renderLowStockTable();
                
                // Show success popup
                alert(`✅ Buku "${title}" telah berjaya ditambah!\n\n📚 Maklumat Buku:\n• Tajuk: ${title}\n• ISBN: ${isbn}\n• Rak: ${rak || 'Tidak dinyatakan'}\n• Stok Awal: ${quantity} unit\n\nBuku kini boleh digunakan dalam sistem Kad Petak Digital.`);
            });
            
            // Set default date to today and auto-update
            function setTodayDate() {
                document.getElementById('transaction-date').value = new Date().toISOString().split('T')[0];
            }
            setTodayDate();
            
            // Auto-set date when tab is switched to pengeluaran
            document.getElementById('pengeluaran-tab').addEventListener('click', function() {
                setTimeout(setTodayDate, 100);
            });
            
            // Kad Petak Digital Security - Single login for entire section
            let kadPetakSecurity = {
                isLoggedIn: false
            };
            
            // Check saved login session
            const savedKadPetakLogin = localStorage.getItem('kadPetakLogin');
            
            // Check kad petak session
            if (savedKadPetakLogin) {
                try {
                    const loginData = JSON.parse(savedKadPetakLogin);
                    const now = new Date().getTime();
                    if (now - loginData.timestamp < 8 * 60 * 60 * 1000) {
                        kadPetakSecurity.isLoggedIn = true;
                        document.getElementById('kad-petak-login').style.display = 'none';
                        document.getElementById('kad-petak-content').style.display = 'block';
                    } else {
                        localStorage.removeItem('kadPetakLogin');
                    }
                } catch (e) {
                    localStorage.removeItem('kadPetakLogin');
                }
            }
            
            // Kad Petak login function
            function handleKadPetakLogin() {
                console.log('🔐 Login function called');
                
                try {
                    const employeeInput = document.getElementById('kad-petak-employee');
                    const passwordInput = document.getElementById('kad-petak-password');
                    const errorDiv = document.getElementById('kad-petak-error');
                    const loginDiv = document.getElementById('kad-petak-login');
                    const contentDiv = document.getElementById('kad-petak-content');
                    
                    console.log('🔍 Checking DOM elements...');
                    console.log('Employee input found:', !!employeeInput);
                    console.log('Password input found:', !!passwordInput);
                    console.log('Error div found:', !!errorDiv);
                    console.log('Login div found:', !!loginDiv);
                    console.log('Content div found:', !!contentDiv);
                    
                    if (!employeeInput || !passwordInput || !errorDiv || !loginDiv || !contentDiv) {
                        console.error('❌ Missing DOM elements for login');
                        alert('Ralat: Elemen login tidak dijumpai. Sila refresh halaman.');
                        return;
                    }
                    
                    const employeeNumber = employeeInput.value.trim();
                    const password = passwordInput.value;
                    
                    console.log('📝 Login attempt:', { 
                        employeeNumber: employeeNumber, 
                        passwordLength: password ? password.length : 0,
                        passwordProvided: password ? 'Yes' : 'No'
                    });
                    
                    // Check if fields are filled
                    if (!employeeNumber || !password) {
                        console.log('❌ Missing credentials');
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Sila isi No. Pekerja dan Kata Laluan!';
                        return;
                    }
                    
                    console.log('🔍 Checking credentials...');
                    console.log('Expected employee:', '352198');
                    console.log('Provided employee:', employeeNumber);
                    console.log('Expected password:', '123456');
                    console.log('Provided password:', password);
                    
                    if (employeeNumber === '352198' && password === '123456') {
                        console.log('✅ Login successful!');
                        
                        // Successful login
                        kadPetakSecurity.isLoggedIn = true;
                        
                        // Save login session
                        try {
                            localStorage.setItem('kadPetakLogin', JSON.stringify({
                                timestamp: new Date().getTime(),
                                employee: employeeNumber
                            }));
                            console.log('💾 Login session saved');
                        } catch (storageError) {
                            console.error('Storage error:', storageError);
                        }
                        
                        // Hide login form and show content
                        console.log('🔄 Updating UI...');
                        loginDiv.style.display = 'none';
                        contentDiv.style.display = 'block';
                        
                        // Clear form
                        employeeInput.value = '';
                        passwordInput.value = '';
                        errorDiv.style.display = 'none';
                        
                        console.log('🎉 UI updated successfully');
                        console.log('Login div display:', loginDiv.style.display);
                        console.log('Content div display:', contentDiv.style.display);
                        
                        // Show success message
                        setTimeout(() => {
                            alert('✅ Berjaya log masuk ke Kad Petak Digital!\n\nSelamat datang ke sistem pengurusan stok.\n\nAnda kini boleh mengakses semua fungsi:\n• Pengeluaran & Penambahan\n• Kad Petak\n• Tambah Buku');
                        }, 500);
                        
                    } else {
                        console.log('❌ Login failed - incorrect credentials');
                        console.log('Employee match:', employeeNumber === '352198');
                        console.log('Password match:', password === '123456');
                        
                        // Failed login
                        errorDiv.style.display = 'block';
                        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>No. Pekerja atau Kata Laluan tidak sah!';
                        
                        // Clear password field
                        passwordInput.value = '';
                        
                        // Focus back to employee number if wrong
                        if (employeeNumber !== '352198') {
                            employeeInput.focus();
                            employeeInput.select();
                        } else {
                            passwordInput.focus();
                        }
                    }
                } catch (error) {
                    console.error('🚨 Login function error:', error);
                    alert('Ralat sistem semasa login: ' + error.message);
                }
            }
            
            // Kad Petak logout function
            function handleKadPetakLogout() {
                if (confirm('Adakah anda pasti mahu log keluar dari Kad Petak Digital?')) {
                    kadPetakSecurity.isLoggedIn = false;
                    
                    // Remove login session
                    localStorage.removeItem('kadPetakLogin');
                    
                    // Show login form and hide content
                    document.getElementById('kad-petak-login').style.display = 'block';
                    document.getElementById('kad-petak-content').style.display = 'none';
                    
                    // Clear any error messages
                    document.getElementById('kad-petak-error').style.display = 'none';
                    
                    alert('Anda telah berjaya log keluar dari Kad Petak Digital.');
                }
            }
            
            // Kad Petak login event listeners
            document.getElementById('kad-petak-login-btn').addEventListener('click', handleKadPetakLogin);
            document.getElementById('kad-petak-logout-btn').addEventListener('click', handleKadPetakLogout);
            
            // Enter key support for kad petak login
            document.getElementById('kad-petak-employee').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('kad-petak-password').focus();
                }
            });
            
            document.getElementById('kad-petak-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleKadPetakLogin();
                }
            });
            
            // Add some sample books if none exist
            if (data.books.length === 0) {
                const sampleBooks = [
                    {
                        id: '1',
                        title: 'Matematik Tingkatan 4',
                        isbn: '978-967-123-456-7',
                        rak: 'A1-01',
                        currentStock: 150,
                        initialStock: 200,
                        owner: 'Ajim',
                        createdDate: new Date().toISOString()
                    },
                    {
                        id: '2',
                        title: 'Bahasa Melayu Tingkatan 5',
                        isbn: '978-967-123-457-8',
                        rak: 'B2-05',
                        currentStock: 80,
                        initialStock: 100,
                        owner: 'Ajim',
                        createdDate: new Date().toISOString()
                    },
                    {
                        id: '3',
                        title: 'Sejarah Malaysia',
                        isbn: '978-967-123-458-9',
                        rak: 'C3-10',
                        currentStock: 50,
                        initialStock: 75,
                        owner: 'Ajim',
                        createdDate: new Date().toISOString()
                    }
                ];
                
                data.books = sampleBooks;
                
                // Add initial transactions for sample books
                sampleBooks.forEach(book => {
                    data.transactions.push({
                        id: Date.now() + Math.random(),
                        bookId: book.id,
                        transactionId: 'INITIAL',
                        date: new Date().toISOString().split('T')[0],
                        grnNumber: 'INITIAL',
                        type: 'masuk',
                        quantity: book.initialStock,
                        balanceAfter: book.initialStock,
                        balanceBefore: 0,
                        notes: 'Stok awal'
                    });
                });
                
                // Re-render tables
                renderAllBooksTable();
                renderLowStockTable();
            }

            // Auto-connect to Google Apps Script on startup
            async function autoConnectToSheet() {
                if (!sheetsConfig.isConnected) {
                    try {
                        // Test connection to Apps Script using FormData
                        const formData = new FormData();
                        formData.append('action', 'testConnection');
                        formData.append('timestamp', new Date().toISOString());
                        
                        const response = await fetch(sheetsConfig.appsScriptUrl, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            let result;
                            try {
                                result = await response.json();
                            } catch (jsonError) {
                                // If we can't parse JSON, assume connection is working
                                result = { success: true };
                            }
                            
                            if (result.success) {
                                // Auto-connect
                                sheetsConfig.autoSync = true;
                                sheetsConfig.isConnected = true;
                                
                                // Try to load existing data
                                await loadDataFromSheets();
                                
                                // Save config
                                saveSheetsConfig();
                                
                                // Update UI
                                updateSyncStatus();
                                renderTables();
                                calculateMonthlyTotals();
                                
                                console.log('✅ Auto-connected to Google Apps Script successfully!');
                                
                                // Show success message
                                setTimeout(() => {
                                    alert('✅ Berjaya disambung ke Google Apps Script!\n\nSekarang anda boleh:\n1. Tambah data baru dalam sistem\n2. Data akan auto-sync ke Google Sheets\n3. Buka sistem di komputer lain untuk akses data yang sama');
                                }, 2000);
                            } else {
                                throw new Error(result.error || 'Apps Script connection failed');
                            }
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.log('Auto-connect failed:', error.message);
                        
                        // Don't show error popup on auto-connect failure - just log it
                        console.log('Sistem akan berfungsi dalam mod offline. Data disimpan dalam browser sahaja.');
                        
                        // Load data from localStorage if available
                        const savedData = localStorage.getItem('salesData');
                        if (savedData) {
                            try {
                                const parsedData = JSON.parse(savedData);
                                Object.assign(data, parsedData);
                                renderTables();
                                calculateMonthlyTotals();
                                console.log('📱 Data dimuat dari localStorage');
                            } catch (e) {
                                console.error('Error loading from localStorage:', e);
                            }
                        }
                    }
                }
            }
            
            // Call auto-connect
            setTimeout(autoConnectToSheet, 1000);
            
            // Google Sheets setup event listeners (if button exists)
            const setupBtn = document.getElementById('setup-sheets-btn');
            if (setupBtn) {
                setupBtn.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(document.getElementById('setupModal'));
                    
                    // Load existing config or use your Google Sheet
                    const defaultUrl = 'https://docs.google.com/spreadsheets/d/1bXHjQFaWfzE6nFZjlYYMzYqOfxId8UtzSVHEXQhiVgg/edit?gid=0#gid=0';
                    document.getElementById('sheets-url').value = sheetsConfig.spreadsheetId ? 
                        `https://docs.google.com/spreadsheets/d/${sheetsConfig.spreadsheetId}/edit` : defaultUrl;
                    document.getElementById('api-key').value = sheetsConfig.apiKey || '';
                    document.getElementById('auto-sync').checked = sheetsConfig.autoSync;
                    
                    modal.show();
                });
            }
            
            document.getElementById('test-connection-btn').addEventListener('click', async function() {
                const url = document.getElementById('sheets-url').value;
                const statusDiv = document.getElementById('connection-status');
                const statusText = document.getElementById('status-text');
                
                if (!url) {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'Sila masukkan URL Google Sheets!';
                    return;
                }
                
                const spreadsheetId = extractSpreadsheetId(url);
                if (!spreadsheetId) {
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'URL Google Sheets tidak sah!';
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
                this.disabled = true;
                
                try {
                    // Test connection using CSV export URL
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv&gid=0`;
                    
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error('Tidak dapat mengakses Google Sheet. Pastikan sheet boleh diakses oleh public (Share > Anyone with the link can view).');
                    }
                    
                    const csvText = await response.text();
                    
                    statusDiv.className = 'alert alert-success';
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'Sambungan berjaya! Google Sheets boleh diakses dan dibaca.';
                    
                } catch (error) {
                    console.error('Connection test failed:', error);
                    statusDiv.className = 'alert alert-danger';
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'Sambungan gagal: ' + error.message;
                }
                
                this.innerHTML = '<i class="fas fa-wifi me-2"></i>Test Connection';
                this.disabled = false;
            });
            
            document.getElementById('save-setup-btn').addEventListener('click', async function() {
                const url = document.getElementById('sheets-url').value;
                const autoSync = document.getElementById('auto-sync').checked;
                
                if (!url) {
                    alert('Sila masukkan URL Google Sheets!');
                    return;
                }
                
                const spreadsheetId = extractSpreadsheetId(url);
                if (!spreadsheetId) {
                    alert('URL Google Sheets tidak sah!');
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                this.disabled = true;
                
                try {
                    // Update config
                    sheetsConfig.spreadsheetId = spreadsheetId;
                    sheetsConfig.autoSync = autoSync;
                    sheetsConfig.isConnected = true;
                    
                    // Try to load existing data from sheets
                    await loadDataFromSheets();
                    
                    // Save config
                    saveSheetsConfig();
                    
                    // Update UI
                    updateSyncStatus();
                    renderTables();
                    calculateMonthlyTotals();
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('setupModal'));
                    modal.hide();
                    
                    alert('Setup berjaya! Data telah dimuat dari Google Sheets (jika ada). Gunakan butang "Sync Manual" untuk export data terkini ke Google Sheets.');
                    
                } catch (error) {
                    console.error('Setup failed:', error);
                    alert('Setup gagal: ' + error.message);
                    sheetsConfig.isConnected = false;
                }
                
                this.innerHTML = '<i class="fas fa-save me-2"></i>Simpan & Sync';
                this.disabled = false;
            });
            
            document.getElementById('manual-sync-btn').addEventListener('click', async function() {
                if (!sheetsConfig.isConnected) {
                    alert('Google Apps Script tidak disambung!');
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
                this.disabled = true;
                
                try {
                    await saveDataToSheets('manual');
                    alert('✅ Data berjaya disimpan ke Google Sheets!');
                } catch (error) {
                    alert('❌ Sync gagal: ' + error.message);
                }
                
                this.innerHTML = '<i class="fas fa-sync me-1"></i>Sync Manual';
                this.disabled = false;
            });
            
            document.getElementById('load-data-btn').addEventListener('click', async function() {
                if (!sheetsConfig.isConnected) {
                    alert('Google Apps Script tidak disambung!');
                    return;
                }
                
                if (!confirm('Adakah anda pasti mahu memuat data dari Google Sheets? Data tempatan akan diganti.')) {
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                this.disabled = true;
                
                try {
                    await loadDataFromSheets('manual');
                    renderTables();
                    calculateMonthlyTotals();
                    alert('✅ Data berjaya dimuat dari Google Sheets!');
                } catch (error) {
                    alert('❌ Load data gagal: ' + error.message);
                }
                
                this.innerHTML = '<i class="fas fa-download me-1"></i>Load Data';
                this.disabled = false;
            });
            
            // Add CSV export button listener (if exists)
            const csvBtn = document.getElementById('export-csv-btn');
            if (csvBtn) {
                csvBtn.addEventListener('click', function() {
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating CSV...';
                    this.disabled = true;
                    
                    setTimeout(() => {
                        try {
                            downloadCSVFile();
                            this.innerHTML = '<i class="fas fa-file-csv me-2"></i>Export CSV';
                            this.disabled = false;
                        } catch (error) {
                            alert('Ralat semasa menjana CSV. Sila cuba lagi.');
                            this.innerHTML = '<i class="fas fa-file-csv me-2"></i>Export CSV';
                            this.disabled = false;
                        }
                    }, 100);
                });
            }
            
            document.getElementById('disconnect-btn').addEventListener('click', function() {
                if (confirm('Adakah anda pasti mahu memutuskan sambungan dengan Google Apps Script?')) {
                    sheetsConfig.isConnected = false;
                    sheetsConfig.spreadsheetId = null;
                    sheetsConfig.apiKey = null;
                    sheetsConfig.autoSync = false;
                    sheetsConfig.lastSync = null;
                    
                    saveSheetsConfig();
                    updateSyncStatus();
                    
                    alert('Sambungan dengan Google Apps Script telah diputuskan.');
                }
            });
        });

// Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz7FESkyoLWXPVqXpGCF0NiYmG1VpLysHl9dUXbSOURQ9511dvR3WHp-4Q8f2ONFmmc/exec';
        
        // Sample order data (fallback)
        let orders = {
            'ORD001': {
                id: 'ORD001',
                dealerName: 'Ahmad Bookstore',
                email: 'ahmad@bookstore.com',
                phone: '012-3456789',
                address: 'No. 123, Jalan Buku, Taman Ilmu, 50000 Kuala Lumpur',
                deliveryType: 'Pos',
                status: 'Pending',
                books: [
                    { title: 'Buku Teks Matematik Tingkatan 4', quantity: 20 },
                    { title: 'Buku Latihan Sains Tingkatan 5', quantity: 15 }
                ],
                tracking: null,
                doNumber: null,
                hasReceipt: true
            },
            'ORD002': {
                id: 'ORD002',
                dealerName: 'Siti Books & Stationery',
                email: 'siti@books.com',
                phone: '013-7654321',
                address: 'No. 456, Jalan Pendidikan, Bandar Baru, 40000 Shah Alam',
                deliveryType: 'Pickup',
                status: 'Pending',
                books: [
                    { title: 'Buku Sejarah Tingkatan 2', quantity: 30 },
                    { title: 'Atlas Malaysia', quantity: 10 }
                ],
                tracking: null,
                doNumber: null,
                hasReceipt: true
            },
            'ORD003': {
                id: 'ORD003',
                dealerName: 'Rahman Educational Supplies',
                email: 'rahman@edu.com',
                phone: '014-9876543',
                address: 'No. 789, Jalan Akademik, Taman Universiti, 43600 Bangi',
                deliveryType: 'Pos',
                status: 'Selesai',
                books: [
                    { title: 'Kamus Dewan Bahasa', quantity: 25 },
                    { title: 'Buku Rujukan Kimia', quantity: 12 }
                ],
                tracking: 'TRK987654321',
                doNumber: 'DO123456',
                hasReceipt: true
            }
        };

        function viewOrderDetails(orderId) {
            const order = orders[orderId];
            if (!order) return;

            // Populate modal with order details
            document.getElementById('modalOrderId').textContent = `#${orderId}`;
            document.getElementById('dealerName').textContent = order.dealerName;
            document.getElementById('dealerEmail').textContent = order.email;
            document.getElementById('dealerPhone').textContent = order.phone;
            document.getElementById('dealerAddress').textContent = order.address;
            document.getElementById('deliveryType').innerHTML = `<i class="fas fa-${order.deliveryType === 'Pos' ? 'shipping-fast' : 'store'} me-1"></i>${order.deliveryType}`;
            
            // Status with appropriate styling
            const statusClass = order.status === 'Pending' ? 'status-pending' : 
                               order.status === 'Dalam Proses' ? 'status-processing' : 'status-completed';
            document.getElementById('orderStatus').innerHTML = `<span class="status-badge ${statusClass}">${order.status}</span>`;

            // Books list
            const booksList = document.getElementById('booksList');
            booksList.innerHTML = order.books.map(book => 
                `<div class="mb-2 p-3 rounded" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);">
                    <span>${book.title}</span>
                </div>`
            ).join('');

            // Tracking section
            const trackingSection = document.getElementById('trackingSection');
            const currentTracking = document.getElementById('currentTracking');
            
            if (order.status === 'Pending') {
                trackingSection.style.display = 'block';
                
                if (order.tracking && order.doNumber) {
                    document.getElementById('displayTracking').textContent = order.tracking;
                    document.getElementById('displayDO').textContent = order.doNumber;
                    currentTracking.style.display = 'block';
                    document.getElementById('trackingNumber').value = order.tracking;
                    document.getElementById('doNumber').value = order.doNumber;
                } else {
                    currentTracking.style.display = 'none';
                    document.getElementById('trackingNumber').value = order.tracking || '';
                    document.getElementById('doNumber').value = order.doNumber || '';
                }
            } else if (order.status === 'Selesai' && (order.tracking || order.doNumber)) {
                trackingSection.style.display = 'block';
                document.getElementById('displayTracking').textContent = order.tracking || '-';
                document.getElementById('displayDO').textContent = order.doNumber || '-';
                currentTracking.style.display = 'block';
                document.getElementById('trackingNumber').value = order.tracking || '';
                document.getElementById('doNumber').value = order.doNumber || '';
                // Hide the input fields and button for completed orders
                document.querySelector('#trackingSection .row.mb-3').style.display = 'none';
                document.querySelector('#trackingSection .text-center').style.display = 'none';
            } else {
                trackingSection.style.display = 'none';
            }

            // Show modal
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        }

        function deleteOrder(orderId) {
            if (confirm(`Adakah anda pasti mahu memadam order #${orderId}?`)) {
                // Remove from orders object
                delete orders[orderId];
                
                // Remove from table - find row by checking button onclick attribute
                const tableBody = document.getElementById('ordersTableBody');
                const rows = Array.from(tableBody.getElementsByTagName('tr'));
                
                for (let row of rows) {
                    const buttons = row.querySelectorAll('button[onclick*="' + orderId + '"]');
                    if (buttons.length > 0) {
                        row.remove();
                        break;
                    }
                }
                
                // Update counters
                updateCounters();
                
                alert(`Order #${orderId} telah berjaya dipadam.`);
            }
        }

        async function saveTracking() {
            const trackingNumber = document.getElementById('trackingNumber').value.trim();
            const doNumber = document.getElementById('doNumber').value.trim();
            const orderId = document.getElementById('modalOrderId').textContent.replace('#', '');
            
            if (!trackingNumber && !doNumber) {
                alert('Sila masukkan sekurang-kurangnya No. DO atau No. Tracking.');
                return;
            }

            // Show loading
            const saveButton = document.querySelector('#trackingSection .btn-success');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Menyimpan...';
            saveButton.disabled = true;

            try {
                // Create URL with parameters for GET request (to avoid CORS issues)
                const params = new URLSearchParams({
                    action: 'updateOrder',
                    orderId: orderId,
                    doNumber: doNumber || '',
                    tracking: trackingNumber || '',
                    status: 'Selesai'
                });

                const updateUrl = `${GOOGLE_SCRIPT_URL}?${params.toString()}`;
                console.log('Saving to Google Sheets:', updateUrl);
                
                const response = await fetch(updateUrl, {
                    method: 'GET',
                    mode: 'no-cors'
                });

                console.log('Save response received');

                // Update local data
                if (orders[orderId]) {
                    orders[orderId].tracking = trackingNumber || null;
                    orders[orderId].doNumber = doNumber || null;
                    orders[orderId].status = 'Selesai';
                    
                    // Update display
                    document.getElementById('displayTracking').textContent = trackingNumber || '-';
                    document.getElementById('displayDO').textContent = doNumber || '-';
                    document.getElementById('currentTracking').style.display = 'block';
                    
                    // Hide input fields and button
                    document.querySelector('#trackingSection .row.mb-3').style.display = 'none';
                    document.querySelector('#trackingSection .text-center').style.display = 'none';
                    
                    // Update status in modal
                    document.getElementById('orderStatus').innerHTML = '<span class="status-badge status-completed">Selesai</span>';
                    
                    // Update table row
                    updateTableRow(orderId);
                    
                    // Update counters
                    updateCounters();
                }

                let message = '✅ Data berjaya disimpan ke Google Sheets! Status order telah dikemaskini kepada "Selesai".';
                if (doNumber && trackingNumber) {
                    message = `✅ No. DO (${doNumber}) dan No. Tracking (${trackingNumber}) berjaya disimpan ke Google Sheets!`;
                } else if (doNumber) {
                    message = `✅ No. DO (${doNumber}) berjaya disimpan ke Google Sheets!`;
                } else if (trackingNumber) {
                    message = `✅ No. Tracking (${trackingNumber}) berjaya disimpan ke Google Sheets!`;
                }
                
                alert(message);

                // Reload data after 2 seconds to confirm save
                setTimeout(() => {
                    loadOrdersFromSheets();
                }, 2000);

            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                
                // Still update local data even if save fails
                if (orders[orderId]) {
                    orders[orderId].tracking = trackingNumber || null;
                    orders[orderId].doNumber = doNumber || null;
                    orders[orderId].status = 'Selesai';
                    
                    updateTableRow(orderId);
                    updateCounters();
                }
                
                alert('⚠️ Data disimpan secara tempatan, tetapi gagal menyimpan ke Google Sheets. Sila cuba lagi.');
                
                // Restore button
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        function updateTableRow(orderId) {
            const tableBody = document.getElementById('ordersTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const orderCell = row.cells[0];
                if (orderCell && orderCell.textContent.includes(orderId)) {
                    const statusCell = row.cells[3];
                    statusCell.innerHTML = '<span class="status-badge status-completed">Selesai</span>';
                    
                    // Update DO number in table
                    const doCell = document.getElementById(`do-${orderId}`);
                    if (doCell && orders[orderId] && orders[orderId].doNumber) {
                        doCell.textContent = orders[orderId].doNumber;
                    }
                    break;
                }
            }
        }

        function updateCounters() {
            let pending = 0, completed = 0;
            
            Object.values(orders).forEach(order => {
                if (order.status === 'Pending') pending++;
                else if (order.status === 'Selesai') completed++;
            });
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalCount').textContent = pending + completed;
        }

        // Simulate new orders coming in (for demo purposes)
        function simulateNewOrder() {
            // This would normally come from Google Sheets integration
            console.log('New order received from Google Form!');
            
            // In real implementation, this would:
            // 1. Fetch data from Google Sheets API
            // 2. Add new rows to the table
            // 3. Update counters
            // 4. Show notification
        }

        // Test connection function
        async function testConnection() {
            const loadingStatus = document.getElementById('loadingStatus');
            const errorStatus = document.getElementById('errorStatus');
            const dataStatus = document.getElementById('dataStatus');
            
            loadingStatus.style.display = 'block';
            errorStatus.style.display = 'none';
            dataStatus.textContent = '';
            
            try {
                console.log('Testing connection to:', GOOGLE_SCRIPT_URL);
                const response = await fetch(GOOGLE_SCRIPT_URL);
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                const rawText = await response.text();
                console.log('Raw response:', rawText);
                
                const data = JSON.parse(rawText);
                console.log('Parsed data:', data);
                
                loadingStatus.style.display = 'none';
                
                if (data.error) {
                    errorStatus.textContent = 'Apps Script Error: ' + data.error;
                    errorStatus.style.display = 'block';
                } else if (Array.isArray(data)) {
                    dataStatus.textContent = `✅ Connected! Found ${data.length} records`;
                    dataStatus.className = 'text-success ms-3';
                } else {
                    dataStatus.textContent = '⚠️ Connected but unexpected data format';
                    dataStatus.className = 'text-warning ms-3';
                }
                
            } catch (error) {
                loadingStatus.style.display = 'none';
                errorStatus.textContent = 'Connection Error: ' + error.message;
                errorStatus.style.display = 'block';
                console.error('Connection test failed:', error);
            }
        }

        // Load data from Google Sheets
        async function loadOrdersFromSheets() {
            const loadingStatus = document.getElementById('loadingStatus');
            const errorStatus = document.getElementById('errorStatus');
            const dataStatus = document.getElementById('dataStatus');
            
            try {
                loadingStatus.style.display = 'block';
                errorStatus.style.display = 'none';
                
                console.log('Loading data from:', GOOGLE_SCRIPT_URL);
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const rawText = await response.text();
                console.log('Raw response:', rawText);
                
                const data = JSON.parse(rawText);
                console.log('Parsed data:', data);
                
                loadingStatus.style.display = 'none';
                
                if (data.error) {
                    errorStatus.textContent = 'Apps Script Error: ' + data.error;
                    errorStatus.style.display = 'block';
                    return;
                }
                
                if (!Array.isArray(data) || data.length === 0) {
                    dataStatus.textContent = '⚠️ No data found in Google Sheets';
                    dataStatus.className = 'text-warning ms-3';
                    return;
                }
                
                // Clear existing orders
                orders = {};
                
                // Convert sheet data to orders object
                data.forEach((order, index) => {
                    console.log(`Processing order ${index}:`, order);
                    
                    if (order.dealerName) { // Check dealer name instead of orderId
                        const orderId = order.orderId || `ORD${String(index + 1).padStart(3, '0')}`;
                        orders[orderId] = {
                            id: orderId,
                            dealerName: order.dealerName,
                            email: order.email || '',
                            phone: order.phone || '',
                            address: order.address || '',
                            deliveryType: order.deliveryType || 'Pos',
                            status: order.status || 'Pending',
                            date: order.date || '', // Ambil dari kolum Timestamp
                            books: order.books ? 
                                order.books.split('\n').filter(book => book.trim()).map(book => ({ title: book.trim(), quantity: 1 })) : 
                                [{ title: 'No books listed', quantity: 1 }],
                            tracking: order.tracking || null,
                            doNumber: order.doNumber || null,
                            hasReceipt: false
                        };
                    }
                });
                
                console.log('Processed orders:', orders);
                
                // Update table and counters
                updateOrdersTable();
                updateCounters();
                
                dataStatus.textContent = `✅ Loaded ${Object.keys(orders).length} orders from Google Sheets`;
                dataStatus.className = 'text-success ms-3';
                
            } catch (error) {
                loadingStatus.style.display = 'none';
                errorStatus.textContent = 'Error: ' + error.message;
                errorStatus.style.display = 'block';
                console.error('Error loading data from Google Sheets:', error);
                
                dataStatus.textContent = '❌ Using sample data instead';
                dataStatus.className = 'text-warning ms-3';
            }
        }
        
        // Update orders table
        function updateOrdersTable() {
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '';
            
            let rowNumber = 1;
            Object.values(orders).forEach(order => {
                const row = `
                    <tr>
                        <td><strong>${rowNumber}</strong></td>
                        <td>${order.dealerName}</td>
                        <td>${order.date || '-'}</td>
                        <td><span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span></td>
                        <td><i class="fas fa-${order.deliveryType === 'Pos' ? 'shipping-fast' : 'store'} me-1"></i> ${order.deliveryType}</td>
                        <td id="do-${order.id}">${order.doNumber || '-'}</td>
                        <td>
                            <button class="btn btn-primary btn-action" onclick="viewOrderDetails('${order.id}')" title="Lihat Detail">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger btn-action" onclick="deleteOrder('${order.id}')" title="Padam Order">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
                rowNumber++;
            });
        }

        // Initialize counters on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from Google Sheets first
            loadOrdersFromSheets();
            
            // Refresh data every 30 seconds
            setInterval(loadOrdersFromSheets, 30000);
        });

        function exportOrdersPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("Senarai Order", 14, 15);

    doc.autoTable({
        startY: 20,
        head: [['Bil.', 'Nama Pengedar', 'Tarikh', 'Status', 'Jenis', 'No. DO']],
        body: Array.from(document.querySelectorAll("#ordersTableBody tr")).map(row => {
            return Array.from(row.querySelectorAll("td")).slice(0, 6).map(cell => cell.innerText.trim());
        }),
        styles: { fontSize: 10 }
    });

    doc.save(`Senarai_Order_${new Date().toLocaleDateString('ms-MY')}.pdf`);
}

    </script>
</body>
</html>























